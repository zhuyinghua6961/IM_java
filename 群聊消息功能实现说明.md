# 群聊消息功能实现说明

## 功能概述

本次实现了完整的群聊消息发送功能，包括：

1. **群成员验证**：发送消息前验证发送者是否是群成员
2. **消息持久化**：保存群聊消息到数据库
3. **会话管理**：自动为所有群成员创建/更新会话记录
4. **实时推送**：通过WebSocket推送消息给所有在线群成员（排除发送者）
5. **历史消息**：支持查询群聊历史消息

## 核心实现文件

### 后端服务层

1. **im-user-service**
   - `GroupMemberService.java` - 群成员服务接口
   - `GroupMemberServiceImpl.java` - 群成员服务实现

2. **im-message-service**
   - `GroupMember.java` - 群成员实体（消息服务使用）
   - `GroupMemberMapper.java` - 群成员数据访问
   - `GroupMemberMapper.xml` - MyBatis映射文件
   - `MessageServiceImpl.java` - 消息服务实现（已增强）
   - `WebSocketMessageHandler.java` - WebSocket消息处理器（已优化）

## 数据库准备

### 确保表结构完整

执行以下SQL确认/创建必要的表：

```sql
-- 1. 确认 group 表存在
SHOW TABLES LIKE 'group';

-- 2. 确认 group_member 表存在且包含必要字段
DESC group_member;

-- 3. 如果缺少 update_time 字段，执行：
ALTER TABLE group_member 
ADD COLUMN update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间' 
AFTER status;

-- 4. 确认 message 表存在
DESC message;

-- 5. 确认 conversation 表存在
DESC conversation;
```

### 准备测试数据

```sql
-- 1. 创建测试用户（如果还没有）
INSERT INTO user (username, password, nickname, avatar, status) VALUES
('user1', 'password123', '用户1', 'http://example.com/avatar1.jpg', 1),
('user2', 'password123', '用户2', 'http://example.com/avatar2.jpg', 1),
('user3', 'password123', '用户3', 'http://example.com/avatar3.jpg', 1);

-- 2. 创建测试群组
INSERT INTO `group` (name, avatar, owner_id, member_count, status, create_time) VALUES
('测试群组', 'http://example.com/group-avatar.jpg', 1, 3, 1, NOW());

-- 3. 添加群成员（假设群组ID为1）
INSERT INTO group_member (group_id, user_id, role, status, join_time) VALUES
(1, 1, 1, 1, NOW()),  -- 用户1是群主
(1, 2, 3, 1, NOW()),  -- 用户2是普通成员
(1, 3, 3, 1, NOW());  -- 用户3是普通成员
```

## API测试流程

### 1. 用户登录获取Token

**接口**: `POST http://localhost:8081/api/auth/login`

**请求体**:
```json
{
  "username": "user1",
  "password": "password123"
}
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userId": 1,
    "username": "user1",
    "nickname": "用户1"
  }
}
```

保存返回的 `token`，后续请求需要在Header中携带。

### 2. 建立WebSocket连接

**连接地址**: `ws://localhost:8082/ws`

**连接参数**:
- 在URL中添加token: `ws://localhost:8082/ws?token=YOUR_TOKEN`
- 或在Header中添加: `Authorization: Bearer YOUR_TOKEN`

**连接成功后订阅**:
```javascript
// 订阅私有消息队列
stompClient.subscribe('/user/queue/messages', function(message) {
    console.log('收到消息:', JSON.parse(message.body));
});

// 订阅ACK确认
stompClient.subscribe('/user/queue/ack-' + sessionId, function(ack) {
    console.log('消息发送成功:', JSON.parse(ack.body));
});

// 订阅群组主题（可选，用于降级方案）
stompClient.subscribe('/topic/group-1', function(message) {
    console.log('收到群组消息:', JSON.parse(message.body));
});
```

### 3. 发送群聊消息

**通过WebSocket发送**:

发送到 `/app/message` 端点：

```json
{
  "groupId": 1,
  "chatType": 2,
  "msgType": 1,
  "content": "大家好，这是一条测试消息"
}
```

**消息类型说明**:
- `chatType`: 1-单聊, 2-群聊
- `msgType`: 1-文本, 2-图片, 3-视频, 4-文件, 5-语音

### 4. 接收消息

**发送者收到ACK确认**:
```json
{
  "type": "ACK",
  "messageId": 123456,
  "status": "success",
  "timestamp": 1701234567890
}
```

**群成员收到消息**:
```json
{
  "type": "MESSAGE",
  "messageId": 123456,
  "fromUserId": 1,
  "groupId": 1,
  "chatType": 2,
  "msgType": 1,
  "content": "大家好，这是一条测试消息",
  "url": null,
  "timestamp": 1701234567890
}
```

### 5. 获取群聊历史消息

**接口**: `GET http://localhost:8082/api/message/history?targetId=1&chatType=2&page=1&size=20`

**Header**: `Authorization: Bearer YOUR_TOKEN`

**响应**:
```json
{
  "code": 200,
  "data": {
    "total": 10,
    "list": [
      {
        "id": 123456,
        "fromUserId": 1,
        "toId": 1,
        "chatType": 2,
        "msgType": 1,
        "content": "大家好，这是一条测试消息",
        "url": null,
        "status": 1,
        "sendTime": "2024-11-27 16:30:00"
      }
    ]
  }
}
```

### 6. 获取会话列表

**接口**: `GET http://localhost:8082/api/conversation/list`

**Header**: `Authorization: Bearer YOUR_TOKEN`

**响应**:
```json
{
  "code": 200,
  "data": [
    {
      "conversationId": 1,
      "targetId": 1,
      "chatType": 2,
      "unreadCount": 5,
      "top": false,
      "hidden": false,
      "lastMsgTime": "2024-11-27 16:30:00"
    }
  ]
}
```

## 功能验证要点

### 1. 群成员验证
- ✅ 非群成员发送消息应该被拒绝，返回403错误
- ✅ 群成员可以正常发送消息

### 2. 消息持久化
- ✅ 消息保存到 `message` 表
- ✅ `chat_type` = 2 表示群聊
- ✅ `to_id` = 群组ID

### 3. 会话管理
- ✅ 所有群成员的 `conversation` 表都有对应记录
- ✅ 发送者的会话 `unread_count` 不增加
- ✅ 其他成员的会话 `unread_count` +1

### 4. 实时推送
- ✅ 发送者收到ACK确认
- ✅ 所有在线群成员收到消息（除发送者）
- ✅ 消息内容完整准确

### 5. 离线消息
- ✅ 离线成员重新上线后，会话列表显示未读数
- ✅ 可以通过历史消息接口获取离线期间的消息

## 常见问题排查

### 1. 消息发送失败：您不是该群的成员

**原因**：
- 用户不在群成员表中
- 群成员状态为0（已退出）

**解决**：
```sql
-- 检查群成员状态
SELECT * FROM group_member WHERE group_id = 1 AND user_id = YOUR_USER_ID;

-- 如果不存在，插入记录
INSERT INTO group_member (group_id, user_id, role, status, join_time) 
VALUES (1, YOUR_USER_ID, 3, 1, NOW());
```

### 2. WebSocket连接失败

**检查**：
- 服务是否启动：`http://localhost:8082`
- Token是否有效
- 网络连接是否正常

### 3. 消息推送不到

**检查**：
- WebSocket连接状态
- 订阅的队列是否正确：`/user/queue/messages`
- 查看后端日志是否有推送记录

### 4. 会话未更新

**检查**：
```sql
-- 查看会话记录
SELECT * FROM conversation WHERE user_id = YOUR_USER_ID AND target_id = 1 AND chat_type = 2;
```

## 前端集成示例

### 使用SockJS + STOMP

```javascript
// 1. 建立连接
const socket = new SockJS('http://localhost:8082/ws?token=' + token);
const stompClient = Stomp.over(socket);

stompClient.connect({}, function(frame) {
    console.log('WebSocket连接成功');
    
    // 订阅消息
    stompClient.subscribe('/user/queue/messages', function(message) {
        const msg = JSON.parse(message.body);
        console.log('收到消息:', msg);
        
        if (msg.chatType === 2) {
            // 处理群聊消息
            displayGroupMessage(msg);
        }
    });
});

// 2. 发送群聊消息
function sendGroupMessage(groupId, content) {
    const message = {
        groupId: groupId,
        chatType: 2,
        msgType: 1,
        content: content
    };
    
    stompClient.send('/app/message', {}, JSON.stringify(message));
}

// 3. 显示消息
function displayGroupMessage(msg) {
    const messageElement = document.createElement('div');
    messageElement.innerHTML = `
        <div class="message">
            <span class="user">用户${msg.fromUserId}</span>:
            <span class="content">${msg.content}</span>
            <span class="time">${new Date(msg.timestamp).toLocaleString()}</span>
        </div>
    `;
    document.getElementById('messageList').appendChild(messageElement);
}
```

## 性能优化建议

1. **批量推送优化**：对于大群（成员>100），可以考虑使用消息队列异步推送
2. **缓存优化**：群成员列表可以缓存到Redis，减少数据库查询
3. **分页加载**：历史消息使用分页，避免一次加载过多数据
4. **消息压缩**：对于图片、视频等大文件，使用URL引用而非直接传输内容

## 总结

群聊消息功能已完整实现，包括：
- ✅ 群成员权限验证
- ✅ 消息持久化存储
- ✅ 实时消息推送
- ✅ 会话自动管理
- ✅ 历史消息查询

可以按照上述测试流程进行验证，如有问题请检查日志输出和数据库状态。
