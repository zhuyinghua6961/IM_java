<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.im.square.mapper.SquareCommentMapper">

    <resultMap id="BaseResultMap" type="com.im.square.entity.SquareComment">
        <id column="id" property="id"/>
        <result column="post_id" property="postId"/>
        <result column="user_id" property="userId"/>
        <result column="parent_id" property="parentId"/>
        <result column="content" property="content"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, post_id, user_id, parent_id, content, status, create_time
    </sql>

    <!-- 插入评论 -->
    <insert id="insert" parameterType="com.im.square.entity.SquareComment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO square_comment (post_id, user_id, parent_id, content, status, create_time)
        VALUES (#{postId}, #{userId}, #{parentId}, #{content}, #{status}, #{createTime})
    </insert>

    <!-- 根据ID查询评论 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM square_comment
        WHERE id = #{id}
    </select>

    <!-- 软删除评论（作者删除） -->
    <update id="softDelete">
        UPDATE square_comment
        SET status = 0
        WHERE id = #{id}
          AND user_id = #{userId}
          AND status != 0
    </update>

    <!-- 查询帖子下的评论列表（仅正常状态） -->
    <select id="selectByPost" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM square_comment
        WHERE post_id = #{postId}
          AND status = 1
        ORDER BY create_time ASC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countByPost" resultType="long">
        SELECT COUNT(*)
        FROM square_comment
        WHERE post_id = #{postId}
          AND status = 1
    </select>

</mapper>
