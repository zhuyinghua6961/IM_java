# æ¶ˆæ¯åˆ é™¤åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²å®ç°å®Œæ•´çš„å•æ¡æ¶ˆæ¯åˆ é™¤åŠŸèƒ½ï¼Œæ”¯æŒæ‚¬åœæ˜¾ç¤ºæ“ä½œèœå•ï¼Œæ ¹æ®æ’¤å›æ—¶é—´æ™ºèƒ½æ˜¾ç¤ºæ“ä½œé€‰é¡¹ã€‚

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. æ‚¬åœæ˜¾ç¤ºæ“ä½œèœå•

- âœ… é¼ æ ‡æ‚¬åœåˆ°**è‡ªå·±å‘é€çš„æ¶ˆæ¯**æ—¶ï¼Œæ˜¾ç¤ºæ“ä½œæŒ‰é’®
- âœ… æ“ä½œæŒ‰é’®æµ®åŠ¨åœ¨æ¶ˆæ¯æ°”æ³¡å³ä¸Šè§’
- âœ… ç¦»å¼€æ¶ˆæ¯åŒºåŸŸåï¼Œæ“ä½œæŒ‰é’®è‡ªåŠ¨éšè—

### 2. æ™ºèƒ½æ˜¾ç¤ºæ“ä½œé€‰é¡¹

#### æœªè¿‡æ’¤å›æ—¶é—´ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
- æ˜¾ç¤ºï¼š`æ’¤å›` + `åˆ é™¤`
- æ’¤å›ï¼šæ‰€æœ‰äººéƒ½çœ‹ä¸åˆ°è¿™æ¡æ¶ˆæ¯
- åˆ é™¤ï¼šä»…è‡ªå·±ä¸å¯è§ï¼Œå¯¹æ–¹ä»å¯è§

#### å·²è¿‡æ’¤å›æ—¶é—´ï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰
- åªæ˜¾ç¤ºï¼š`åˆ é™¤`
- åˆ é™¤åä»…è‡ªå·±ä¸å¯è§

### 3. å•ä¾§åˆ é™¤ç‰¹æ€§

- âœ… åˆ é™¤åæ¶ˆæ¯ä»è‡ªå·±çš„èŠå¤©è®°å½•ä¸­ç§»é™¤
- âœ… å¯¹æ–¹çš„èŠå¤©è®°å½•ä¸å—å½±å“
- âœ… å¯ä»¥åˆ é™¤ä»»æ„æ—¶é—´çš„æ¶ˆæ¯ï¼ˆæ²¡æœ‰æ—¶é—´é™åˆ¶ï¼‰
- âœ… åˆ é™¤æ“ä½œä¸å¯æ’¤é”€

---

## ğŸ¨ ç•Œé¢å±•ç¤º

### æ‚¬åœæ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä½ å¥½ï¼Œåœ¨å—ï¼Ÿ               â”‚
â”‚                   [æ’¤å›][åˆ é™¤] â”‚ â† æ‚¬åœæ˜¾ç¤º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŒ‰é’®æ ·å¼

- **æ’¤å›æŒ‰é’®**ï¼šæ·±ç°è‰²èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­—
- **åˆ é™¤æŒ‰é’®**ï¼šçº¢è‰²èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­—
- æ‚¬åœæ—¶æŒ‰é’®é¢œè‰²åŠ æ·±

---

## ğŸ’» ä½¿ç”¨æ–¹å¼

### 1. åˆ é™¤æ¶ˆæ¯

1. é¼ æ ‡ç§»åŠ¨åˆ°**è‡ªå·±å‘é€çš„æ¶ˆæ¯**ä¸Š
2. æ“ä½œæŒ‰é’®è‡ªåŠ¨æ˜¾ç¤ºåœ¨æ¶ˆæ¯å³ä¸Šè§’
3. ç‚¹å‡»"åˆ é™¤"æŒ‰é’®
4. ç¡®è®¤åˆ é™¤æç¤ºæ¡†
5. æ¶ˆæ¯ä»èŠå¤©è®°å½•ä¸­ç§»é™¤

### 2. æ’¤å›æ¶ˆæ¯ï¼ˆ5åˆ†é’Ÿå†…ï¼‰

1. é¼ æ ‡ç§»åŠ¨åˆ°æ¶ˆæ¯ä¸Š
2. ç‚¹å‡»"æ’¤å›"æŒ‰é’®
3. ç¡®è®¤æ’¤å›
4. æ¶ˆæ¯æ˜¾ç¤ºä¸º"ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯"

---

## ğŸ” æ“ä½œé€»è¾‘

### æ’¤å›æ—¶é—´åˆ¤æ–­

```javascript
// 5åˆ†é’Ÿå†…å¯ä»¥æ’¤å›
const canRecall = (message) => {
  const now = new Date()
  const sendTime = new Date(message.sendTime)
  const diffMinutes = (now - sendTime) / (1000 * 60)
  
  return diffMinutes <= 5 // 5åˆ†é’Ÿå†…
}
```

### æ“ä½œæŒ‰é’®æ˜¾ç¤ºè§„åˆ™

```
if (æ¶ˆæ¯æ˜¯è‡ªå·±å‘çš„ && é¼ æ ‡æ‚¬åœ && ä¸æ˜¯æ’¤å›æ¶ˆæ¯ && ä¸æ˜¯å‘é€ä¸­) {
  if (æœªè¿‡æ’¤å›æ—¶é—´) {
    æ˜¾ç¤ºï¼š[æ’¤å›] [åˆ é™¤]
  } else {
    æ˜¾ç¤ºï¼š[åˆ é™¤]
  }
}
```

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | æ’¤å› | åˆ é™¤ |
|------|------|------|
| **æ—¶é—´é™åˆ¶** | 5åˆ†é’Ÿå†… | æ— é™åˆ¶ |
| **å¯¹æ–¹å¯è§** | ä¸å¯è§ï¼ˆæ˜¾ç¤ºæ’¤å›æç¤ºï¼‰ | å¯è§ |
| **æ¶ˆæ¯çŠ¶æ€** | ä¿®æ”¹ä¸ºå·²æ’¤å› | æ ‡è®°ä¸ºå·²åˆ é™¤ |
| **æ•°æ®åº“** | æ›´æ–°messageè¡¨ | æ’å…¥message_deleteè¡¨ |
| **å¯é€†æ€§** | ä¸å¯æ¢å¤ | ä¸å¯æ¢å¤ |

---

## ğŸ” å®‰å…¨ç‰¹æ€§

### 1. æƒé™æ§åˆ¶

- âœ… åªèƒ½åˆ é™¤/æ’¤å›**è‡ªå·±å‘é€çš„æ¶ˆæ¯**
- âœ… ä¸èƒ½åˆ é™¤/æ’¤å›åˆ«äººçš„æ¶ˆæ¯
- âœ… åç«¯éªŒè¯userIdï¼Œé˜²æ­¢è¶Šæƒæ“ä½œ

### 2. ç¡®è®¤æœºåˆ¶

```javascript
// åˆ é™¤ç¡®è®¤
await ElMessageBox.confirm(
  'åˆ é™¤åä»…è‡ªå·±ä¸å¯è§ï¼Œå¯¹æ–¹ä»ç„¶å¯ä»¥çœ‹åˆ°ã€‚ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ',
  'åˆ é™¤æ¶ˆæ¯',
  { type: 'warning' }
)

// æ’¤å›ç¡®è®¤
await ElMessageBox.confirm(
  'ç¡®å®šè¦æ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ',
  'æ’¤å›æ¶ˆæ¯',
  { type: 'warning' }
)
```

### 3. æ•°æ®ä¸€è‡´æ€§

- âœ… åˆ é™¤åç«‹å³ä»å‰ç«¯ç§»é™¤
- âœ… åç«¯è®°å½•åˆ é™¤å…³ç³»åˆ°`message_delete`è¡¨
- âœ… æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤æ¶ˆæ¯

---

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### å‰ç«¯å®ç°

#### 1. APIæ¥å£

```javascript
// src/api/message.js

/**
 * åˆ é™¤å•æ¡æ¶ˆæ¯
 */
export function deleteMessage(messageId) {
  return request({
    url: `/message/${messageId}`,
    method: 'delete'
  })
}
```

#### 2. æ‚¬åœçŠ¶æ€ç®¡ç†

```vue
<script setup>
const hoveredMessageId = ref(null) // å½“å‰æ‚¬åœçš„æ¶ˆæ¯ID

// æ¶ˆæ¯é¡¹
<div
  @mouseenter="hoveredMessageId = msg.id"
  @mouseleave="hoveredMessageId = null"
>
</script>
```

#### 3. æ¡ä»¶æ˜¾ç¤ºæŒ‰é’®

```vue
<div 
  v-if="msg.fromUserId === currentUserId && 
        hoveredMessageId === msg.id && 
        !isRecalledMessage(msg) && 
        !isSendingMessage(msg)" 
  class="message-actions"
>
  <!-- æ’¤å›æŒ‰é’®ï¼ˆ5åˆ†é’Ÿå†…ï¼‰ -->
  <el-button 
    v-if="canRecall(msg)"
    @click="recallMessage(msg)"
  >
    æ’¤å›
  </el-button>
  
  <!-- åˆ é™¤æŒ‰é’®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
  <el-button 
    @click="deleteMessage(msg)"
    class="delete-btn"
  >
    åˆ é™¤
  </el-button>
</div>
```

#### 4. åˆ é™¤é€»è¾‘

```javascript
const deleteMessage = async (message) => {
  try {
    await ElMessageBox.confirm('...')
    await deleteMessageApi(message.id)
    
    // ä»æœ¬åœ°æ¶ˆæ¯åˆ—è¡¨ä¸­ç§»é™¤
    const index = messages.value.findIndex(m => m.id === message.id)
    if (index !== -1) {
      messages.value.splice(index, 1)
    }
    
    ElMessage.success('æ¶ˆæ¯å·²åˆ é™¤')
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
}
```

### åç«¯å®ç°ï¼ˆå·²å®Œæˆï¼‰

#### 1. APIæ¥å£

```java
// MessageController.java

@DeleteMapping("/{messageId}")
public Result<Void> deleteMessage(@PathVariable Long messageId) {
    messageService.deleteMessage(messageId);
    return Result.success();
}
```

#### 2. æœåŠ¡å®ç°

```java
// MessageServiceImpl.java

@Override
public void deleteMessage(Long messageId) {
    // 1. è·å–å½“å‰ç”¨æˆ·
    Long userId = UserContext.getCurrentUserId();
    
    // 2. éªŒè¯æ¶ˆæ¯å­˜åœ¨
    Message message = messageMapper.selectById(messageId);
    
    // 3. éªŒè¯æƒé™ï¼ˆåªèƒ½åˆ é™¤è‡ªå·±çš„æ¶ˆæ¯ï¼‰
    if (!message.getFromUserId().equals(userId)) {
        throw new BusinessException(ResultCode.FORBIDDEN);
    }
    
    // 4. æ’å…¥åˆ é™¤è®°å½•
    MessageDelete messageDelete = new MessageDelete();
    messageDelete.setMessageId(messageId);
    messageDelete.setUserId(userId);
    messageDeleteMapper.insert(messageDelete);
}
```

#### 3. æŸ¥è¯¢è¿‡æ»¤

```xml
<!-- MessageMapper.xml -->

SELECT m.* FROM message m
LEFT JOIN message_delete md 
  ON m.id = md.message_id AND md.user_id = #{userId}
WHERE m.status = 1 
  AND md.id IS NULL  -- æ’é™¤å·²åˆ é™¤çš„æ¶ˆæ¯
  AND ...
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### å‰ç«¯
1. âœ… `src/api/message.js` - æ·»åŠ åˆ é™¤æ¶ˆæ¯API
2. âœ… `src/views/Chat.vue` - å®ç°æ‚¬åœèœå•å’Œåˆ é™¤åŠŸèƒ½

### åç«¯ï¼ˆå·²å®Œæˆï¼‰
1. âœ… `MessageController.java` - åˆ é™¤æ¶ˆæ¯æ¥å£
2. âœ… `MessageService.java` - æœåŠ¡æ¥å£
3. âœ… `MessageServiceImpl.java` - æœåŠ¡å®ç°
4. âœ… `MessageMapper.xml` - SQLæŸ¥è¯¢ä¼˜åŒ–

### æ•°æ®åº“ï¼ˆå·²å®Œæˆï¼‰
1. âœ… `message_delete` è¡¨ - è®°å½•åˆ é™¤å…³ç³»

---

## ğŸ¯ æ ·å¼ç‰¹æ€§

### CSSå®ç°

```css
/* æ“ä½œæŒ‰é’®å®¹å™¨ */
.message-actions {
  position: absolute;
  top: -12px;
  right: -8px;
  display: flex;
  gap: 6px;
  opacity: 0;  /* é»˜è®¤éšè— */
  transition: opacity 0.2s;
}

/* æ‚¬åœæ—¶æ˜¾ç¤º */
.message-bubble:hover .message-actions {
  opacity: 1;
}

/* æŒ‰é’®æ ·å¼ */
.message-actions .action-btn {
  font-size: 12px;
  padding: 4px 10px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* åˆ é™¤æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
.message-actions .delete-btn {
  background: rgba(245, 108, 108, 0.9);  /* çº¢è‰² */
}

.message-actions .delete-btn:hover {
  background: rgba(245, 108, 108, 1);
}
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šåˆ é™¤æœ€è¿‘çš„æ¶ˆæ¯

1. å‘é€ä¸€æ¡æ–°æ¶ˆæ¯
2. é¼ æ ‡æ‚¬åœï¼Œåº”è¯¥çœ‹åˆ°"æ’¤å›"å’Œ"åˆ é™¤"ä¸¤ä¸ªæŒ‰é’®
3. ç‚¹å‡»"åˆ é™¤"
4. ç¡®è®¤åˆ é™¤
5. æ¶ˆæ¯ä»åˆ—è¡¨ä¸­ç§»é™¤

### åœºæ™¯2ï¼šåˆ é™¤æ—§æ¶ˆæ¯

1. æ‰¾ä¸€æ¡è¶…è¿‡5åˆ†é’Ÿçš„æ¶ˆæ¯
2. é¼ æ ‡æ‚¬åœï¼Œåº”è¯¥åªçœ‹åˆ°"åˆ é™¤"æŒ‰é’®ï¼ˆæ²¡æœ‰æ’¤å›ï¼‰
3. ç‚¹å‡»"åˆ é™¤"
4. æ¶ˆæ¯è¢«åˆ é™¤

### åœºæ™¯3ï¼šæ’¤å›æ¶ˆæ¯

1. å‘é€æ–°æ¶ˆæ¯
2. 5åˆ†é’Ÿå†…ç‚¹å‡»"æ’¤å›"
3. æ¶ˆæ¯æ˜¾ç¤ºä¸º"ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯"

### åœºæ™¯4ï¼šå¯¹æ–¹è§†è§’

1. ç”¨æˆ·Aåˆ é™¤è‡ªå·±å‘çš„æ¶ˆæ¯
2. ç”¨æˆ·Båˆ·æ–°èŠå¤©ï¼Œæ¶ˆæ¯ä»ç„¶å­˜åœ¨
3. å•ä¾§åˆ é™¤ç”Ÿæ•ˆ

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### å¼€å‘ç¯å¢ƒ
- å¯ä»¥å°†æ’¤å›æ—¶é—´æ”¹ä¸ºæ›´é•¿ï¼ˆå¦‚30åˆ†é’Ÿï¼‰ï¼Œæ–¹ä¾¿æµ‹è¯•

### ç”Ÿäº§ç¯å¢ƒ
- æ’¤å›æ—¶é—´ï¼š5åˆ†é’Ÿï¼ˆå¾®ä¿¡æ ‡å‡†ï¼‰
- åˆ é™¤æ—¶é—´ï¼šæ— é™åˆ¶

### ç”¨æˆ·æç¤º
å»ºè®®åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤ºå¼•å¯¼ï¼š
- "åˆ é™¤"ï¼šä»…è‡ªå·±ä¸å¯è§
- "æ’¤å›"ï¼šåŒæ–¹éƒ½ä¸å¯è§

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- åç«¯å®ç°: `åˆ é™¤åŠŸèƒ½å®ç°è¯´æ˜.md`
- APIæ–‡æ¡£: `APIæ¥å£è®¾è®¡.md`
- æ•°æ®åº“è®¾è®¡: `init/mysql/init.sql`
