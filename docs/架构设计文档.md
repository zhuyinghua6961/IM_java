# 仿微信聊天系统架构设计文档

## 1. 系统概述

基于 SpringBoot 的分布式即时通讯系统，采用前后端分离架构，支持单聊、群聊、朋友圈等核心功能。

## 2. 技术栈

### 2.1 后端技术栈
- **框架**: Spring Boot 3.x
- **WebSocket**: Spring WebSocket + STOMP
- **消息队列**: Apache Kafka
- **缓存**: Redis
- **数据库**: MySQL 8.0
- **对象存储**: MinIO
- **认证授权**: Spring Security + JWT
- **API文档**: Knife4j (Swagger)
- **ORM**: MyBatis-Plus
- **服务注册发现**: Nacos (可选)
- **网关**: Spring Cloud Gateway (可选)

### 2.2 前端技术栈
- **框架**: Vue 3 + TypeScript
- **UI组件库**: Element Plus / Ant Design Vue
- **状态管理**: Pinia
- **路由**: Vue Router
- **HTTP客户端**: Axios
- **WebSocket客户端**: Socket.io-client / SockJS
- **构建工具**: Vite

## 3. 系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         前端层 (Vue3)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 聊天界面 │  │ 朋友圈   │  │ 通讯录   │  │ 个人中心 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │ HTTPS/WSS
┌─────────────────────────────────────────────────────────────┐
│                    API网关 (Gateway)                         │
│              负载均衡 / 路由转发 / 鉴权                      │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
┌───────▼────────┐  ┌──────▼──────┐  ┌────────▼────────┐
│  用户服务模块   │  │  消息服务模块 │  │  朋友圈服务模块  │
│  (User)        │  │  (Message)   │  │  (Moments)      │
│                │  │              │  │                 │
│ - 用户注册登录  │  │ - 单聊消息   │  │ - 发布动态      │
│ - 个人信息管理  │  │ - 群聊消息   │  │ - 点赞评论      │
│ - 好友关系管理  │  │ - 消息推送   │  │ - 动态浏览      │
│ - 群组管理     │  │ - 消息存储   │  │                 │
└────────────────┘  └──────────────┘  └─────────────────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
┌───────▼────────┐  ┌──────▼──────┐  ┌────────▼────────┐
│     MySQL      │  │    Redis     │  │     Kafka       │
│                │  │              │  │                 │
│ - 用户数据     │  │ - 会话缓存   │  │ - 消息队列      │
│ - 消息记录     │  │ - 在线状态   │  │ - 异步处理      │
│ - 好友关系     │  │ - 未读计数   │  │ - 消息分发      │
│ - 群组信息     │  │ - 热点数据   │  │                 │
└────────────────┘  └──────────────┘  └─────────────────┘
                            │
                    ┌───────▼────────┐
                    │     MinIO      │
                    │                │
                    │ - 图片存储     │
                    │ - 视频存储     │
                    │ - 文件存储     │
                    └────────────────┘
```

### 3.2 微服务模块划分

#### 3.2.1 用户服务 (im-user-service)
- 用户注册、登录、登出
- JWT Token 生成与验证
- 用户信息管理（头像、昵称、个性签名）
- 好友关系管理（添加、删除、查询）
- 群组管理（创建、解散、成员管理）
- 黑名单管理

#### 3.2.2 消息服务 (im-message-service)
- WebSocket 连接管理
- 单聊消息收发
- 群聊消息收发
- 消息持久化
- 消息已读/未读状态
- 消息撤回
- 历史消息查询
- 消息推送（离线消息）

#### 3.2.3 朋友圈服务 (im-moments-service)
- 动态发布（文字、图片、视频）
- 动态删除
- 点赞/取消点赞
- 评论/删除评论
- 动态浏览（时间线）
- 权限控制（可见范围）

#### 3.2.4 文件服务 (im-file-service)
- 文件上传（图片、视频、文档）
- 文件下载
- 缩略图生成
- 文件预览
- MinIO 对接

#### 3.2.5 网关服务 (im-gateway)
- 统一入口
- 路由转发
- 负载均衡
- 限流熔断
- 全局鉴权

## 4. 数据库设计

### 4.1 用户相关表

#### user (用户表)
```sql
CREATE TABLE `user` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
  `password` VARCHAR(255) NOT NULL COMMENT '密码(加密)',
  `nickname` VARCHAR(50) COMMENT '昵称',
  `avatar` VARCHAR(255) COMMENT '头像URL',
  `gender` TINYINT DEFAULT 0 COMMENT '性别 0-未知 1-男 2-女',
  `phone` VARCHAR(20) UNIQUE COMMENT '手机号',
  `email` VARCHAR(100) COMMENT '邮箱',
  `signature` VARCHAR(255) COMMENT '个性签名',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-禁用 1-正常',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_username (`username`),
  INDEX idx_phone (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### friend (好友关系表)
```sql
CREATE TABLE `friend` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `friend_id` BIGINT NOT NULL COMMENT '好友ID',
  `remark` VARCHAR(50) COMMENT '备注名',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-已删除 1-正常',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_friend (`user_id`, `friend_id`),
  INDEX idx_user_id (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='好友关系表';
```

#### friend_request (好友申请表)
```sql
CREATE TABLE `friend_request` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `from_user_id` BIGINT NOT NULL COMMENT '申请人ID',
  `to_user_id` BIGINT NOT NULL COMMENT '接收人ID',
  `message` VARCHAR(255) COMMENT '申请消息',
  `status` TINYINT DEFAULT 0 COMMENT '状态 0-待处理 1-已同意 2-已拒绝',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_to_user (`to_user_id`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='好友申请表';
```

### 4.2 群组相关表

#### `group` (群组表)
```sql
CREATE TABLE `group` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '群组ID',
  `group_name` VARCHAR(50) NOT NULL COMMENT '群名称',
  `avatar` VARCHAR(255) COMMENT '群头像',
  `owner_id` BIGINT NOT NULL COMMENT '群主ID',
  `notice` VARCHAR(500) COMMENT '群公告',
  `max_members` INT DEFAULT 500 COMMENT '最大成员数',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-已解散 1-正常',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_owner (`owner_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群组表';
```

#### group_member (群成员表)
```sql
CREATE TABLE `group_member` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `group_id` BIGINT NOT NULL COMMENT '群组ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `role` TINYINT DEFAULT 0 COMMENT '角色 0-普通成员 1-管理员 2-群主',
  `nickname` VARCHAR(50) COMMENT '群昵称',
  `join_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-已退出 1-正常',
  UNIQUE KEY uk_group_user (`group_id`, `user_id`),
  INDEX idx_user_id (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群成员表';
```

### 4.3 消息相关表

#### message (消息表)
```sql
CREATE TABLE `message` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '消息ID',
  `from_user_id` BIGINT NOT NULL COMMENT '发送者ID',
  `to_id` BIGINT NOT NULL COMMENT '接收者ID(用户ID或群组ID)',
  `chat_type` TINYINT NOT NULL COMMENT '聊天类型 1-单聊 2-群聊',
  `msg_type` TINYINT NOT NULL COMMENT '消息类型 1-文本 2-图片 3-视频 4-文件 5-语音',
  `content` TEXT COMMENT '消息内容',
  `url` VARCHAR(500) COMMENT '媒体文件URL',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-已撤回 1-正常',
  `send_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_chat (`to_id`, `chat_type`, `send_time`),
  INDEX idx_from_user (`from_user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息表';
```

#### message_read (消息已读表)
```sql
CREATE TABLE `message_read` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `message_id` BIGINT NOT NULL COMMENT '消息ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `read_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_msg_user (`message_id`, `user_id`),
  INDEX idx_user_id (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息已读表';
```

#### conversation (会话表)
```sql
CREATE TABLE `conversation` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `target_id` BIGINT NOT NULL COMMENT '对方ID(用户ID或群组ID)',
  `chat_type` TINYINT NOT NULL COMMENT '聊天类型 1-单聊 2-群聊',
  `last_msg_id` BIGINT COMMENT '最后一条消息ID',
  `unread_count` INT DEFAULT 0 COMMENT '未读数',
  `top` TINYINT DEFAULT 0 COMMENT '是否置顶 0-否 1-是',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_target (`user_id`, `target_id`, `chat_type`),
  INDEX idx_user_update (`user_id`, `update_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会话表';
```

### 4.4 朋友圈相关表

#### moments (朋友圈动态表)
```sql
CREATE TABLE `moments` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '动态ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `content` TEXT COMMENT '文字内容',
  `images` JSON COMMENT '图片URL数组',
  `video` VARCHAR(500) COMMENT '视频URL',
  `location` VARCHAR(100) COMMENT '位置',
  `visible_type` TINYINT DEFAULT 0 COMMENT '可见范围 0-公开 1-私密 2-部分可见',
  `visible_users` JSON COMMENT '可见用户ID数组',
  `like_count` INT DEFAULT 0 COMMENT '点赞数',
  `comment_count` INT DEFAULT 0 COMMENT '评论数',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-已删除 1-正常',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_time (`user_id`, `create_time`),
  INDEX idx_create_time (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='朋友圈动态表';
```

#### moments_like (朋友圈点赞表)
```sql
CREATE TABLE `moments_like` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `moments_id` BIGINT NOT NULL COMMENT '动态ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_moments_user (`moments_id`, `user_id`),
  INDEX idx_moments_id (`moments_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='朋友圈点赞表';
```

#### moments_comment (朋友圈评论表)
```sql
CREATE TABLE `moments_comment` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '评论ID',
  `moments_id` BIGINT NOT NULL COMMENT '动态ID',
  `user_id` BIGINT NOT NULL COMMENT '评论人ID',
  `reply_to_id` BIGINT COMMENT '回复的评论ID',
  `content` VARCHAR(500) NOT NULL COMMENT '评论内容',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-已删除 1-正常',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_moments_id (`moments_id`, `create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='朋友圈评论表';
```

## 5. Redis 缓存设计

### 5.1 缓存结构

```
# 用户在线状态
user:online:{userId} -> {serverId, lastHeartbeat}  (String, TTL: 5分钟)

# 用户Token
user:token:{userId} -> {token}  (String, TTL: 7天)

# 会话未读数
conversation:unread:{userId}:{targetId} -> count  (String)

# 用户会话列表
conversation:list:{userId} -> List<ConversationVO>  (Hash, TTL: 1小时)

# 群组成员列表
group:members:{groupId} -> Set<userId>  (Set, TTL: 30分钟)

# 好友列表
user:friends:{userId} -> Set<friendId>  (Set, TTL: 30分钟)

# 朋友圈动态缓存
moments:detail:{momentsId} -> MomentsVO  (Hash, TTL: 10分钟)

# 用户信息缓存
user:info:{userId} -> UserVO  (Hash, TTL: 1小时)

# 消息序列号(保证消息顺序)
msg:seq:{chatType}:{targetId} -> sequence  (String)
```

## 6. Kafka 消息队列设计

### 6.1 Topic 设计

```
# 单聊消息
topic: im.message.private
partition: 按 userId 分区
消息体: {messageId, fromUserId, toUserId, msgType, content, sendTime}

# 群聊消息
topic: im.message.group
partition: 按 groupId 分区
消息体: {messageId, fromUserId, groupId, msgType, content, sendTime}

# 系统通知
topic: im.notification.system
partition: 1
消息体: {type, userId, content, data}

# 朋友圈动态
topic: im.moments.publish
partition: 按 userId 分区
消息体: {momentsId, userId, content, images, createTime}

# 离线消息推送
topic: im.message.offline
partition: 按 userId 分区
消息体: {userId, messages[]}
```

### 6.2 消费者组

- **message-consumer-group**: 消息持久化
- **push-consumer-group**: 消息推送
- **notification-consumer-group**: 系统通知处理

## 7. WebSocket 通信协议

### 7.1 连接建立

```
客户端连接: ws://domain/ws?token={jwt_token}
服务端验证token后建立连接
```

### 7.2 消息格式

```json
{
  "type": "MESSAGE",  // MESSAGE, ACK, HEARTBEAT, NOTIFICATION
  "data": {
    "messageId": "123456",
    "fromUserId": 1001,
    "toId": 1002,
    "chatType": 1,  // 1-单聊 2-群聊
    "msgType": 1,   // 1-文本 2-图片 3-视频 4-文件 5-语音
    "content": "Hello",
    "sendTime": "2024-01-01 12:00:00"
  }
}
```

### 7.3 心跳机制

- 客户端每30秒发送心跳包
- 服务端超过60秒未收到心跳则断开连接
- 心跳消息: `{"type": "HEARTBEAT"}`

## 8. 核心业务流程

### 8.1 单聊消息流程

```
1. 用户A发送消息 -> WebSocket连接
2. 消息服务接收 -> 生成messageId
3. 发送到Kafka (im.message.private)
4. 消费者持久化到MySQL
5. 查询用户B在线状态(Redis)
6. 如果在线: 通过WebSocket推送
   如果离线: 存入离线消息队列
7. 更新会话表和未读数(Redis + MySQL)
8. 返回ACK给用户A
```

### 8.2 群聊消息流程

```
1. 用户A发送群消息 -> WebSocket连接
2. 消息服务接收 -> 生成messageId
3. 发送到Kafka (im.message.group)
4. 消费者持久化到MySQL
5. 从Redis获取群成员列表
6. 遍历群成员:
   - 在线: WebSocket推送
   - 离线: 存入离线消息队列
7. 更新所有成员的会话表和未读数
8. 返回ACK给用户A
```

### 8.3 朋友圈发布流程

```
1. 用户上传图片/视频 -> 文件服务 -> MinIO
2. 获取文件URL
3. 提交朋友圈内容 -> 朋友圈服务
4. 持久化到MySQL
5. 发送到Kafka (im.moments.publish)
6. 异步推送给好友(时间线)
7. 缓存到Redis
```

## 9. 项目目录结构

```
im-chat-system/
├── im-common/                    # 公共模块
│   ├── src/main/java/
│   │   └── com/im/common/
│   │       ├── constant/         # 常量
│   │       ├── enums/            # 枚举
│   │       ├── exception/        # 异常
│   │       ├── utils/            # 工具类
│   │       └── vo/               # 通用VO
│   └── pom.xml
│
├── im-gateway/                   # 网关服务
│   ├── src/main/java/
│   │   └── com/im/gateway/
│   │       ├── config/           # 配置
│   │       ├── filter/           # 过滤器
│   │       └── GatewayApplication.java
│   └── pom.xml
│
├── im-user-service/              # 用户服务
│   ├── src/main/java/
│   │   └── com/im/user/
│   │       ├── controller/       # 控制器
│   │       ├── service/          # 服务层
│   │       ├── mapper/           # 数据访问层
│   │       ├── entity/           # 实体类
│   │       ├── dto/              # 数据传输对象
│   │       ├── vo/               # 视图对象
│   │       └── UserApplication.java
│   └── pom.xml
│
├── im-message-service/           # 消息服务
│   ├── src/main/java/
│   │   └── com/im/message/
│   │       ├── controller/
│   │       ├── service/
│   │       ├── mapper/
│   │       ├── entity/
│   │       ├── websocket/        # WebSocket处理
│   │       ├── kafka/            # Kafka生产者/消费者
│   │       └── MessageApplication.java
│   └── pom.xml
│
├── im-moments-service/           # 朋友圈服务
│   ├── src/main/java/
│   │   └── com/im/moments/
│   │       ├── controller/
│   │       ├── service/
│   │       ├── mapper/
│   │       ├── entity/
│   │       └── MomentsApplication.java
│   └── pom.xml
│
├── im-file-service/              # 文件服务
│   ├── src/main/java/
│   │   └── com/im/file/
│   │       ├── controller/
│   │       ├── service/
│   │       ├── config/           # MinIO配置
│   │       └── FileApplication.java
│   └── pom.xml
│
├── im-frontend/                  # 前端项目
│   ├── src/
│   │   ├── api/                  # API接口
│   │   ├── components/           # 组件
│   │   ├── views/                # 页面
│   │   │   ├── chat/             # 聊天页面
│   │   │   ├── moments/          # 朋友圈页面
│   │   │   ├── contacts/         # 通讯录页面
│   │   │   └── profile/          # 个人中心
│   │   ├── store/                # 状态管理
│   │   ├── router/               # 路由
│   │   ├── utils/                # 工具类
│   │   └── App.vue
│   ├── package.json
│   └── vite.config.ts
│
├── docker-compose.yml            # Docker编排
├── README.md
└── pom.xml                       # 父POM
```

## 10. 部署架构

### 10.1 开发环境
```
单机部署:
- MySQL: 本地安装
- Redis: 本地安装
- Kafka: 本地安装
- MinIO: Docker部署
- 各微服务: IDEA直接运行
```

### 10.2 生产环境
```
分布式部署:
- 负载均衡: Nginx
- 网关集群: 2+ 实例
- 微服务集群: 每个服务 2+ 实例
- MySQL: 主从复制
- Redis: 哨兵模式/集群模式
- Kafka: 集群模式(3+ broker)
- MinIO: 分布式模式
- 容器编排: Kubernetes
```

## 11. 性能优化策略

### 11.1 消息推送优化
- WebSocket连接池管理
- 消息批量推送
- 离线消息合并推送

### 11.2 数据库优化
- 读写分离
- 分库分表(按用户ID/时间)
- 索引优化
- 慢查询监控

### 11.3 缓存优化
- 多级缓存(本地缓存 + Redis)
- 缓存预热
- 缓存穿透/雪崩/击穿防护
- 热点数据识别

### 11.4 消息队列优化
- 合理设置分区数
- 消息批量发送
- 消费者并发处理
- 消息去重

## 12. 安全策略

### 12.1 认证授权
- JWT Token认证
- Token刷新机制
- 接口权限控制

### 12.2 数据安全
- 密码加密(BCrypt)
- 敏感信息加密
- HTTPS传输
- SQL注入防护
- XSS防护

### 12.3 限流防护
- 接口限流(令牌桶/漏桶)
- 用户维度限流
- IP限流

## 13. 监控与日志

### 13.1 监控指标
- 系统指标: CPU、内存、磁盘、网络
- 应用指标: QPS、响应时间、错误率
- 业务指标: 在线用户数、消息量、活跃度

### 13.2 日志管理
- 日志级别: DEBUG、INFO、WARN、ERROR
- 日志收集: ELK Stack
- 链路追踪: SkyWalking/Zipkin

## 14. 开发规范

### 14.1 代码规范
- 遵循阿里巴巴Java开发手册
- 统一代码格式化
- 必要的注释和文档

### 14.2 Git规范
- 分支管理: master、develop、feature、hotfix
- Commit规范: feat/fix/docs/style/refactor/test/chore

### 14.3 接口规范
- RESTful API设计
- 统一响应格式
- 版本控制

## 15. 后续扩展功能

- 语音通话/视频通话
- 消息加密(端到端)
- 消息搜索(ElasticSearch)
- 智能推荐
- 表情包管理
- 红包功能
- 小程序支持
