# 广场（Square）模块设计

> 目标：提供一个独立于消息、朋友圈的公开广场服务，支持发帖、评论、点赞，并集成第三方内容审核。

## 1. 模块定位与边界

- 独立微服务：`im-square-service`
  - 端口：默认 `8085`
  - Spring 应用名：`im-square-service`
- 主要职责：
  - 管理广场帖子、评论、点赞数据
  - 对发帖/评论内容进行合规性审核（通过第三方内容审核 API，可配置）
- 不直接负责的内容：
  - 用户认证、用户基础信息（由 user-service 提供）
  - 即时消息、聊天、群通知（由 message-service 提供）
  - 静态文件存储（图片/视频上传由 file-service 或现有 OSS 方案处理）

## 2. 数据库设计（库：`im_chat`）

所有表统一建在 `im_chat` 数据库中，前缀 `square_` 与朋友圈表（`moments_*`）区分开。

### 2.1 广场帖子表 `square_post`

```sql
CREATE TABLE `square_post` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '帖子ID',
  `user_id` BIGINT NOT NULL COMMENT '发帖用户ID',
  `title` VARCHAR(100) DEFAULT NULL COMMENT '标题',
  `content` TEXT NOT NULL COMMENT '正文内容',
  `images` JSON DEFAULT NULL COMMENT '图片URL数组',
  `video` VARCHAR(500) DEFAULT NULL COMMENT '视频URL',
  `tags` JSON DEFAULT NULL COMMENT '标签数组',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-已删除 1-正常 2-审核未通过',
  `audit_status` TINYINT DEFAULT 0 COMMENT '审核状态 0-未审核/跳过 1-通过 2-拒绝',
  `audit_reason` VARCHAR(255) DEFAULT NULL COMMENT '审核不通过原因',
  `like_count` INT DEFAULT 0 COMMENT '点赞数',
  `comment_count` INT DEFAULT 0 COMMENT '评论数',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_time` (`user_id`,`create_time`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='广场帖子表';
```

### 2.2 点赞表 `square_like`

```sql
CREATE TABLE `square_like` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `post_id` BIGINT NOT NULL COMMENT '帖子ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_post_user` (`post_id`,`user_id`),
  KEY `idx_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='广场点赞表';
```

### 2.3 评论表 `square_comment`

```sql
CREATE TABLE `square_comment` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '评论ID',
  `post_id` BIGINT NOT NULL COMMENT '帖子ID',
  `user_id` BIGINT NOT NULL COMMENT '评论用户ID',
  `parent_id` BIGINT DEFAULT NULL COMMENT '被回复的评论ID',
  `content` VARCHAR(500) NOT NULL COMMENT '评论内容',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-已删除 1-正常 2-审核未通过',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_post_time` (`post_id`,`create_time`),
  KEY `idx_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='广场评论表';
```

## 3. 功能范围（V1）

### 3.1 发帖

- 请求内容：
  - 文本内容（必填）
  - 多图 URL（可选，前端通过文件服务上传后拿到 URL）
  - 视频 URL（可选）
  - 位置（可选，简单字符串）
  - 标签（可选，字符串数组）
- 支持：
  - 作者删除自己的帖子（软删除 `status = 0`）
  - 审核不通过时，`audit_status = 2` 并记录 `audit_reason`

### 3.2 广场列表（Feed）

- 分页获取广场帖子列表（公开内容）：
  - 只返回：`status = 1 AND audit_status = 1` 的帖子
  - 排序：先按创建时间倒序（最新优先）
- 列表项包含：
  - 帖子基础信息：id、标题、内容、图片、视频、标签
  - 作者信息：userId + （可选）userName / avatar（通过 user-service 补充）
  - 互动信息：`likeCount`、`commentCount`、当前用户是否已点赞 `liked`

### 3.3 帖子详情

- 获取单条帖子详情：
  - 返回结构与列表项类似
  - 可附带最新评论列表（或前端单独调评论接口）

### 3.4 点赞 / 取消点赞

- 点赞：
  - 每个用户对同一帖子最多一条记录（依赖 `uk_post_user` 唯一索引）
  - 同时更新 `square_post.like_count` 计数
- 取消点赞：
  - 删除对应 `square_like` 记录
  - `like_count` 减一（不小于 0）

### 3.5 评论 / 回复评论 / 删除评论

- 评论：
  - 支持一级评论 + 对评论的回复（`parent_id`）
  - 审核通过后入库，更新 `square_post.comment_count`
- 删除评论：
  - 评论作者可删除自己的评论
  - 帖子作者可删除自己帖子下的任意评论
  - 实现为软删除：`status = 0` 并同步减少 `comment_count`

### 3.6 我的帖子

- 查询当前登录用户自己发的帖子列表：
  - 可看到审核状态（包括未通过）
  - 排序：按创建时间倒序

## 4. API 设计草案（对外 HTTP）

统一前缀：`/api/square`

### 4.1 发帖

- `POST /api/square/posts`
- 请求体示例：

```json
{
  "title": "可选标题",
  "content": "正文内容",
  "images": ["https://xxx.com/a.jpg"],
  "video": null,
  "tags": ["编程", "生活"]
}
```

- 响应示例：

```json
{
  "code": 200,
  "data": {
    "postId": 1,
    "createTime": "2025-01-01 12:00:00"
  }
}
```

### 4.2 获取广场帖子列表

- `GET /api/square/posts`
- Query 参数：`page`、`size`、`sort`（可选：time/hot）
- 响应示例：

```json
{
  "code": 200,
  "data": {
    "total": 100,
    "list": [
      {
        "postId": 1,
        "userId": 1,
        "userName": "张三",
        "userAvatar": "https://xxx.com/avatar.jpg",
        "title": "标题",
        "content": "正文内容",
        "images": ["https://xxx.com/a.jpg"],
        "video": null,
        "tags": ["编程"],
        "likeCount": 10,
        "commentCount": 5,
        "liked": false,
        "createTime": "2025-01-01 12:00:00"
      }
    ]
  }
}
```

### 4.3 获取帖子详情

- `GET /api/square/posts/{postId}`
- 返回单条帖子详情（结构同列表中的一项，可附带部分评论）。

### 4.4 删除帖子

- `DELETE /api/square/posts/{postId}`
- 仅作者可删除，软删除：`status = 0`。

### 4.5 点赞 / 取消点赞

- 点赞：`POST /api/square/posts/{postId}/like`
- 取消点赞：`DELETE /api/square/posts/{postId}/like`

### 4.6 获取评论列表

- `GET /api/square/posts/{postId}/comments`
- Query 参数：`page`、`size`

### 4.7 发表评论 / 回复评论

- `POST /api/square/posts/{postId}/comments`
- 请求体示例：

```json
{
  "content": "评论内容",
  "parentId": null
}
```

### 4.8 删除评论

- `DELETE /api/square/comments/{commentId}`
- 允许：评论作者或帖子作者。

### 4.9 我的帖子

- `GET /api/square/my/posts`
- 返回当前用户自己发的帖子列表（含审核状态）。

## 5. 内容审核设计

### 5.1 审核入口

- 在以下操作中调用内容审核 service：
  - 发帖：审核 `content`，必要时扩展到图片/视频
  - 评论：审核 `content`

### 5.2 ContentReviewService（square-service 内部）

- 示例接口：

```java
public interface ContentReviewService {
    ReviewResult reviewText(String content);
}

@Data
public class ReviewResult {
    private boolean pass;
    private String reason;
}
```

- 配置示例（application.yml）：

```yaml
content-review:
  enabled: true
  api-url: https://third-party-review-api
  api-key: your-key
  timeout-ms: 3000
```

- 行为约定：
  - 当 `enabled = false` 或未配置 `api-url` 时：直接 `pass = true`，不拦截。
  - 当审核不通过时：
    - 发帖/评论接口返回业务错误（带审核提示文案）；
    - 或者写入库但标记为 `audit_status = 2` / `status = 2`，不在公开列表中展示。

## 6. 与其他服务的交互

- **user-service**：
  - 获取用户昵称、头像等基础信息（可通过 HTTP 或 Feign 调用一个批量查询接口）。
- **message-service（可选）**：
  - 以后可以在有人点赞/评论你的帖子时，通过 message-service 发送站内通知。
- **file-service / OSS（可选）**：
  - 图片/视频由前端上传到文件服务，获得 URL 后再提交给 square-service。

---

后续可以在此文档基础上继续补充：
- 具体的错误码定义（是否新增广场模块专用 ResultCode）
- 管理端功能（帖子/评论审核、举报处理）
- 搜索与推荐策略（热门排序、标签、关键词搜索等）。
