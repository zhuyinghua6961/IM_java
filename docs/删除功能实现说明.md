# åˆ é™¤åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†**å•å‘åˆ é™¤**æœºåˆ¶ï¼Œç”¨æˆ·åˆ é™¤ä¼šè¯æˆ–æ¶ˆæ¯åï¼Œåªå¯¹è‡ªå·±ç”Ÿæ•ˆï¼Œå¯¹æ–¹å®Œå…¨ä¸å—å½±å“ã€‚

---

## ğŸ—ƒï¸ æ•°æ®åº“è®¾è®¡

### æ–°å¢è¡¨ï¼š`message_delete`

```sql
CREATE TABLE `message_delete` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `user_id` BIGINT NOT NULL COMMENT 'åˆ é™¤æ¶ˆæ¯çš„ç”¨æˆ·ID',
  `message_id` BIGINT NOT NULL COMMENT 'è¢«åˆ é™¤çš„æ¶ˆæ¯ID',
  `delete_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_user_message` (`user_id`, `message_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_message_id` (`message_id`)
);
```

**è®¾è®¡æ€è·¯**ï¼š
- ä¸ç›´æ¥åˆ é™¤æ¶ˆæ¯è®°å½•
- é€šè¿‡ `message_delete` è¡¨è®°å½•ç”¨æˆ·åˆ é™¤äº†å“ªäº›æ¶ˆæ¯
- æŸ¥è¯¢æ—¶é€šè¿‡ LEFT JOIN è¿‡æ»¤å·²åˆ é™¤çš„æ¶ˆæ¯

---

## ğŸ¯ å®ç°çš„åŠŸèƒ½

### 1. åˆ é™¤ä¼šè¯ âœ…

**æ¥å£**: `DELETE /api/conversation/{conversationId}`

**å®ç°é€»è¾‘**:
1. æŸ¥è¯¢è¯¥ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯
2. æ‰¹é‡æ’å…¥åˆ° `message_delete` è¡¨
3. åˆ é™¤ä¼šè¯è®°å½•

**æ•ˆæœ**:
- ç”¨æˆ·Aåˆ é™¤ä¸Bçš„ä¼šè¯
- Aè¿™è¾¹ï¼šä¼šè¯æ¶ˆå¤±ï¼Œæ‰€æœ‰èŠå¤©è®°å½•ä¸å¯è§
- Bè¿™è¾¹ï¼šå®Œå…¨ä¸å—å½±å“ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½è¿˜åœ¨

**ä»£ç ä½ç½®**:
- Service: `ConversationServiceImpl.deleteConversation()`
- Controller: `ConversationController.deleteConversation()`

---

### 2. åˆ é™¤å•æ¡æ¶ˆæ¯ âœ…

**æ¥å£**: `DELETE /api/message/{messageId}`

**å®ç°é€»è¾‘**:
1. éªŒè¯æ¶ˆæ¯å­˜åœ¨
2. éªŒè¯ç”¨æˆ·æƒé™ï¼ˆå•èŠåŒæ–¹éƒ½å¯åˆ ï¼Œç¾¤èŠæˆå‘˜å¯åˆ ï¼‰
3. æ’å…¥åˆ é™¤è®°å½•åˆ° `message_delete` è¡¨

**æƒé™è¯´æ˜**:
- **å•èŠ**: å‘é€æ–¹å’Œæ¥æ”¶æ–¹éƒ½å¯ä»¥åˆ é™¤
- **ç¾¤èŠ**: ç¾¤æˆå‘˜å¯ä»¥åˆ é™¤

**ä»£ç ä½ç½®**:
- Service: `MessageServiceImpl.deleteMessage()`
- Controller: `MessageController.deleteMessage()`

---

## ğŸ“ æ ¸å¿ƒä»£ç 

### æŸ¥è¯¢å†å²æ¶ˆæ¯ï¼ˆå·²ä¿®æ”¹ï¼‰

```xml
<!-- MessageMapper.xml -->
<select id="selectHistoryMessages" resultMap="BaseResultMap">
    SELECT m.*
    FROM message m
    LEFT JOIN message_delete md ON m.id = md.message_id AND md.user_id = #{userId}
    WHERE m.status = 1
      AND md.id IS NULL  -- æ’é™¤ç”¨æˆ·åˆ é™¤çš„æ¶ˆæ¯
    ...
</select>
```

### åˆ é™¤ä¼šè¯

```java
// ConversationServiceImpl.java
public void deleteConversation(Long conversationId, Long userId) {
    // 1. æŸ¥è¯¢æ‰€æœ‰æ¶ˆæ¯
    List<Message> messages = messageMapper.selectHistoryMessages(...);
    
    // 2. æ‰¹é‡æ’å…¥åˆ é™¤è®°å½•
    List<MessageDelete> deleteRecords = messages.stream()
        .map(msg -> MessageDelete.builder()
            .userId(userId)
            .messageId(msg.getId())
            .build())
        .collect(Collectors.toList());
    
    messageDeleteMapper.batchInsert(deleteRecords);
    
    // 3. åˆ é™¤ä¼šè¯
    conversationMapper.deleteById(conversationId);
}
```

### åˆ é™¤å•æ¡æ¶ˆæ¯

```java
// MessageServiceImpl.java
public void deleteMessage(Long messageId, Long userId) {
    // 1. éªŒè¯æ¶ˆæ¯å’Œæƒé™
    Message message = messageMapper.selectById(messageId);
    // ... æƒé™éªŒè¯ ...
    
    // 2. æ’å…¥åˆ é™¤è®°å½•
    MessageDelete deleteRecord = MessageDelete.builder()
        .userId(userId)
        .messageId(messageId)
        .build();
    
    messageDeleteMapper.insert(deleteRecord);
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ‰§è¡Œæ•°æ®åº“è„šæœ¬

```bash
mysql -u root -p im_chat < init/mysql/message_delete.sql
```

### 2. é‡æ–°ç¼–è¯‘å’Œå¯åŠ¨æœåŠ¡

```bash
# æ¶ˆæ¯æœåŠ¡
cd im-message-service
mvn clean compile
mvn spring-boot:run
```

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”

| æ“ä½œ | åˆ é™¤ä¼šè¯ | åˆ é™¤å•æ¡æ¶ˆæ¯ | éšè—ä¼šè¯ |
|------|----------|--------------|---------|
| ä¼šè¯æ¶ˆå¤± | âœ… | âŒ | âœ… |
| èŠå¤©è®°å½• | ä¸å¯è§ | è¯¥æ¡æ¶ˆæ¯ä¸å¯è§ | å¯è§ |
| å¯¹æ–¹å½±å“ | æ—  | æ—  | æ—  |
| æ–°æ¶ˆæ¯æ¢å¤ | âœ… ä¼šè¯é‡ç° | âœ… ä¼šè¯ä¿ç•™ | âœ… è‡ªåŠ¨æ˜¾ç¤º |
| å¯æ¢å¤æ€§ | âŒ | âŒ | âœ… |

---

## ğŸ¨ å‰ç«¯é›†æˆ

### åˆ é™¤ä¼šè¯ï¼ˆå·²å®ç°ï¼‰

```javascript
// Chat.vue
const deleteConversation = async (conversationId) => {
  await request.delete(`/conversation/${conversationId}`)
}
```

### åˆ é™¤å•æ¡æ¶ˆæ¯ï¼ˆå¾…å‰ç«¯å®ç°ï¼‰

```javascript
// å»ºè®®åœ¨æ¶ˆæ¯å³é”®èœå•ä¸­æ·»åŠ 
const deleteMessage = async (messageId) => {
  await request.delete(`/message/${messageId}`)
  // ä»æ¶ˆæ¯åˆ—è¡¨ä¸­ç§»é™¤
  messages.value = messages.value.filter(m => m.id !== messageId)
}
```

**å‰ç«¯TODO**:
1. åœ¨æ¶ˆæ¯æ°”æ³¡ä¸Šæ·»åŠ åˆ é™¤æŒ‰é’®/å³é”®èœå•
2. ç¡®è®¤å¯¹è¯æ¡†
3. åˆ é™¤ååˆ·æ–°æ¶ˆæ¯åˆ—è¡¨

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**: 
   - æŸ¥è¯¢å†å²æ¶ˆæ¯æ—¶ä¼š LEFT JOIN `message_delete` è¡¨
   - å»ºè®®åœ¨ `message_delete` è¡¨ä¸Šå»ºç«‹ç´¢å¼•ï¼ˆå·²åˆ›å»ºï¼‰
   - å¤§é‡æ•°æ®æ—¶è€ƒè™‘åˆ†é¡µæŸ¥è¯¢

2. **æ•°æ®æ¸…ç†**:
   - `message_delete` è¡¨ä¼šæŒç»­å¢é•¿
   - å»ºè®®å®šæœŸæ¸…ç†å·²åˆ é™¤æ¶ˆæ¯çš„è®°å½•ï¼ˆå¦‚æ¶ˆæ¯æœ¬èº«å·²è¢«ç‰©ç†åˆ é™¤ï¼‰

3. **ç¾¤èŠè€ƒè™‘**:
   - ç¾¤èŠæ¶ˆæ¯è¢«ä¸€ä¸ªäººåˆ é™¤ä¸å½±å“å…¶ä»–æˆå‘˜
   - æ¯ä¸ªæˆå‘˜å¯ä»¥ç‹¬ç«‹ç®¡ç†è‡ªå·±çœ‹åˆ°çš„æ¶ˆæ¯

4. **æ’¤å› vs åˆ é™¤**:
   - **æ’¤å›**: åŒå‘ç”Ÿæ•ˆï¼Œæ¶ˆæ¯çŠ¶æ€å˜ä¸ºå·²æ’¤å›ï¼Œæ‰€æœ‰äººéƒ½çœ‹åˆ°"æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯"
   - **åˆ é™¤**: å•å‘ç”Ÿæ•ˆï¼Œåªæœ‰åˆ é™¤çš„äººçœ‹ä¸åˆ°ï¼Œå¯¹æ–¹ä¸å—å½±å“

---

## ğŸ”„ å‡çº§å½±å“

**å¯¹ç°æœ‰åŠŸèƒ½çš„å½±å“**:
- âœ… æ— ç ´åæ€§å˜æ›´
- âœ… åªå¢åŠ äº†æ–°è¡¨ï¼Œä¸ä¿®æ”¹ç°æœ‰è¡¨ç»“æ„
- âœ… æŸ¥è¯¢é€»è¾‘ä¼˜åŒ–ï¼Œæ€§èƒ½å½±å“å¯æ¥å—
- âœ… å‘åå…¼å®¹

**éœ€è¦å‰ç«¯æ›´æ–°çš„åœ°æ–¹**:
- åˆ é™¤å•æ¡æ¶ˆæ¯çš„UIï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
- åˆ é™¤ä¼šè¯çš„ç¡®è®¤æç¤ºï¼ˆå·²æ›´æ–°ï¼‰

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- APIæ¥å£æ–‡æ¡£: `APIæ¥å£è®¾è®¡.md`
- æ•°æ®åº“è„šæœ¬: `init/mysql/message_delete.sql`
- å®ä½“ç±»: `MessageDelete.java`
- Mapper: `MessageDeleteMapper.java` + `MessageDeleteMapper.xml`
