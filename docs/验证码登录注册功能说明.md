# 验证码登录注册功能实现说明

## 📋 功能概述

实现了基于短信验证码的注册和多种登录方式：
1. ✅ **注册**：手机号 + 验证码（必须）
2. ✅ **登录方式1**：用户名 + 密码
3. ✅ **登录方式2**：手机号 + 密码
4. ✅ **登录方式3**：手机号 + 验证码

**注意**：验证码为模拟实现，不会真正发送短信，会打印在控制台日志中。

---

## 🎯 实现的功能

### 1. 短信验证码服务

**验证码规则**：
- 6位纯数字
- 有效期：5分钟
- 防刷限制：60秒内只能发送一次

**接口**: `POST /api/user/sms/send`

**实现文件**：
- `SmsCodeService.java` - 接口定义
- `SmsCodeServiceImpl.java` - 实现类
- `RedisConstant.java` - Redis Key常量

**功能**：
```java
// 1. 发送验证码
boolean sendCode(String phone);

// 2. 验证验证码
boolean verifyCode(String phone, String code);

// 3. 清除验证码
void clearCode(String phone);
```

**验证码存储**：
- Redis Key: `sms:code:{phone}`
- 过期时间: 5分钟

---

### 2. 用户注册（需验证码）

**接口**: `POST /api/user/register`

**请求示例**：
```json
{
  "username": "testuser",
  "password": "123456",
  "nickname": "测试用户",
  "phone": "13800138001",
  "code": "123456"
}
```

**验证流程**：
1. ✅ 校验手机号不为空
2. ✅ 校验验证码不为空
3. ✅ 验证短信验证码是否正确
4. ✅ 检查用户名是否已存在
5. ✅ 检查手机号是否已注册
6. ✅ 创建用户
7. ✅ 清除验证码（一次性使用）

---

### 3. 多种登录方式

**接口**: `POST /api/user/login`

#### 方式1：用户名 + 密码

```json
{
  "loginType": "password",
  "username": "testuser",
  "password": "123456"
}
```

#### 方式2：手机号 + 密码

```json
{
  "loginType": "password",
  "phone": "13800138001",
  "password": "123456"
}
```

#### 方式3：手机号 + 验证码（免密登录）

```json
{
  "loginType": "sms",
  "phone": "13800138001",
  "code": "123456"
}
```

**登录流程**：
1. ✅ 根据 `loginType` 判断登录方式
2. ✅ 密码登录：支持用户名或手机号
3. ✅ 验证码登录：验证码正确即可登录
4. ✅ 检查账号状态
5. ✅ 生成JWT Token
6. ✅ Token存入Redis（7天过期）
7. ✅ 返回Token和用户信息

---

## 📝 核心代码

### 验证码生成和验证

```java
// SmsCodeServiceImpl.java

// 生成6位随机验证码
private String generateCode() {
    Random random = new Random();
    StringBuilder code = new StringBuilder();
    for (int i = 0; i < CODE_LENGTH; i++) {
        code.append(random.nextInt(10));
    }
    return code.toString();
}

// 发送验证码（模拟）
public boolean sendCode(String phone) {
    String code = generateCode();
    
    // 存储到Redis
    redisTemplate.opsForValue().set(
        RedisConstant.getSmsCodeKey(phone), 
        code, 
        5, 
        TimeUnit.MINUTES
    );
    
    // 打印到控制台
    log.info("========================================");
    log.info("【短信验证码】");
    log.info("手机号: {}", phone);
    log.info("验证码: {}", code);
    log.info("有效期: 5 分钟");
    log.info("========================================");
    
    return true;
}
```

### 注册验证

```java
// UserServiceImpl.java

public UserVO register(UserDTO userDTO) {
    // 1. 验证手机验证码
    if (!smsCodeService.verifyCode(userDTO.getPhone(), userDTO.getCode())) {
        throw new BusinessException(ResultCode.BAD_REQUEST, "验证码错误或已过期");
    }
    
    // 2. 检查用户名和手机号
    // ...
    
    // 3. 创建用户
    // ...
    
    // 4. 清除验证码（一次性）
    smsCodeService.clearCode(userDTO.getPhone());
    
    return convertToVO(user);
}
```

### 多方式登录

```java
// UserServiceImpl.java

public LoginVO login(LoginDTO loginDTO) {
    User user = null;
    
    // 根据登录方式
    if ("sms".equals(loginDTO.getLoginType())) {
        // 验证码登录
        user = loginBySms(loginDTO);
    } else {
        // 密码登录（默认）
        user = loginByPassword(loginDTO);
    }
    
    // 生成Token
    String token = JwtUtil.generateToken(user.getId(), user.getUsername());
    
    // 返回登录信息
    return buildLoginVO(token, user);
}

// 验证码登录
private User loginBySms(LoginDTO loginDTO) {
    if (!smsCodeService.verifyCode(loginDTO.getPhone(), loginDTO.getCode())) {
        throw new BusinessException(ResultCode.BAD_REQUEST, "验证码错误或已过期");
    }
    
    User user = userMapper.selectByPhone(loginDTO.getPhone());
    smsCodeService.clearCode(loginDTO.getPhone());
    
    return user;
}

// 密码登录（支持用户名或手机号）
private User loginByPassword(LoginDTO loginDTO) {
    User user = null;
    
    // 优先手机号，其次用户名
    if (loginDTO.getPhone() != null) {
        user = userMapper.selectByPhone(loginDTO.getPhone());
    } else if (loginDTO.getUsername() != null) {
        user = userMapper.selectByUsername(loginDTO.getUsername());
    }
    
    // 验证密码
    if (!encryptPassword(loginDTO.getPassword()).equals(user.getPassword())) {
        throw new BusinessException(ResultCode.PASSWORD_ERROR);
    }
    
    return user;
}
```

---

## 🗂️ 文件清单

### 新增文件
1. ✅ `SmsCodeService.java` - 验证码服务接口
2. ✅ `SmsCodeServiceImpl.java` - 验证码服务实现

### 修改文件
1. ✅ `LoginDTO.java` - 扩展支持多种登录方式
2. ✅ `UserDTO.java` - 添加验证码字段
3. ✅ `UserServiceImpl.java` - 实现验证码验证和多种登录
4. ✅ `UserController.java` - 添加发送验证码接口
5. ✅ `RedisConstant.java` - 添加验证码Redis Key
6. ✅ `API接口设计.md` - 更新接口文档

---

## 🚀 使用示例

### 场景1：新用户注册

```bash
# 1. 发送验证码
curl -X POST http://localhost:8081/api/user/sms/send \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138001"}'

# 查看控制台获取验证码：123456

# 2. 注册用户
curl -X POST http://localhost:8081/api/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "123456",
    "nickname": "测试用户",
    "phone": "13800138001",
    "code": "123456"
  }'
```

### 场景2：用户名密码登录

```bash
curl -X POST http://localhost:8081/api/user/login \
  -H "Content-Type: application/json" \
  -d '{
    "loginType": "password",
    "username": "testuser",
    "password": "123456"
  }'
```

### 场景3：手机号验证码登录

```bash
# 1. 发送验证码
curl -X POST http://localhost:8081/api/user/sms/send \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138001"}'

# 2. 验证码登录
curl -X POST http://localhost:8081/api/user/login \
  -H "Content-Type: application/json" \
  -d '{
    "loginType": "sms",
    "phone": "13800138001",
    "code": "123456"
  }'
```

---

## 🔒 安全措施

1. **防止暴力破解**
   - 60秒内只能发送一次验证码
   - 验证码5分钟过期

2. **一次性使用**
   - 验证成功后立即清除验证码
   - 防止重放攻击

3. **密码加密**
   - 使用MD5加密存储
   - 明文密码不存储

4. **Token管理**
   - JWT Token存储在Redis
   - 7天自动过期
   - 登出时清除Token

---

## 📊 Redis数据结构

```
# Token存储
user:token:{userId} = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
TTL: 7天

# 验证码存储
sms:code:{phone} = "123456"
TTL: 5分钟
```

---

## ⚠️ 注意事项

1. **验证码为模拟实现**
   - 不会真正发送短信
   - 验证码打印在控制台
   - 生产环境需接入真实短信服务（阿里云、腾讯云等）

2. **手机号格式**
   - 简单校验：1开头的11位数字
   - 可根据需求加强校验规则

3. **前端适配**
   - 需要更新登录注册表单
   - 添加发送验证码按钮
   - 倒计时防止重复点击

---

## 🎨 前端集成TODO

1. **注册页面**
   ```vue
   - [ ] 添加手机号输入框（必填）
   - [ ] 添加验证码输入框
   - [ ] 添加"发送验证码"按钮
   - [ ] 实现60秒倒计时
   ```

2. **登录页面**
   ```vue
   - [ ] 添加登录方式切换（密码/验证码）
   - [ ] 密码登录支持用户名或手机号
   - [ ] 验证码登录显示手机号输入框和验证码
   - [ ] 发送验证码按钮和倒计时
   ```

---

## 📖 相关文档

- API接口文档: `API接口设计.md`
- 服务实现: `SmsCodeServiceImpl.java`
- 用户服务: `UserServiceImpl.java`
- 控制器: `UserController.java`
