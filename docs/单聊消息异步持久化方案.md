# å•èŠæ¶ˆæ¯å¼‚æ­¥æŒä¹…åŒ–æŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

ä¸ºåº”å¯¹é«˜å¹¶å‘åœºæ™¯ï¼Œå•èŠæ¶ˆæ¯é‡‡ç”¨ **Redisç¼“å­˜ + Kafkaå¼‚æ­¥ + MySQLæŒä¹…åŒ–** çš„ä¸‰å±‚æ¶æ„ï¼Œå®ç°ï¼š
- æ¶ˆæ¯å‘é€ **<10ms** å¿«é€Ÿå“åº”
- æ”¯æŒ **10,000+ QPS**
- 5åˆ†é’Ÿå†…æ’¤å›ä¼˜åŒ–
- æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ä¿è¯

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·A     â”‚ å‘é€æ¶ˆæ¯
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ â‘  å†™å…¥Redis (1ms)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Redis ç¼“å­˜å±‚       â”‚ msg:detail:{id}
â”‚                     â”‚ msg:conv:{convId}
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ â‘¡ å‘é€Kafka (5ms)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kafka æ¶ˆæ¯é˜Ÿåˆ—    â”‚ Topic: im-message-private
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ â‘¢ WebSocketæ¨é€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·B     â”‚ å®æ—¶æ¥æ”¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ â‘£ å¼‚æ­¥æ¶ˆè´¹ (100ms-1s)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MySQL æŒä¹…å±‚      â”‚ messageè¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®æµè¯¦ç»†è®¾è®¡

### 1. æ¶ˆæ¯å‘é€æµç¨‹

```
ç”¨æˆ·Aå‘é€æ¶ˆæ¯ "ä½ å¥½"
    â†“
ç”ŸæˆMessageId (é›ªèŠ±ç®—æ³•)
messageId = 1234567890
    â†“
æ„å»ºMessageå¯¹è±¡
{
  id: 1234567890,
  fromUserId: 1,
  toId: 2,
  content: "ä½ å¥½",
  msgType: 1,
  chatType: 1,
  sendTime: 1732723200000,
  status: 1,
  persistStatus: "PENDING"  â† å…³é”®å­—æ®µ
}
    â†“
å†™å…¥Redis (3ä¸ªKey)
â‘  msg:detail:1234567890 â†’ Message JSON (TTL: 30åˆ†é’Ÿ)
â‘¡ msg:conv:1_2 â†’ List<Message> (LPUSH, ä¿ç•™æœ€è¿‘1000æ¡)
â‘¢ msg:unread:2 â†’ Set<messageId> (ç”¨æˆ·Bçš„æœªè¯»æ¶ˆæ¯)
    â†“
å‘é€åˆ°Kafka
Topic: im-message-private
Partition: conversationId.hashCode() % 10
Message: {"action":"PERSIST", "data": Message}
    â†“
WebSocketæ¨é€ç»™ç”¨æˆ·B (å¦‚æœåœ¨çº¿)
    â†“
è¿”å›æˆåŠŸç»™ç”¨æˆ·A (æ€»è€—æ—¶ < 10ms)
    â†“
[å¼‚æ­¥] Kafkaæ¶ˆè´¹è€…
æ£€æŸ¥æ’¤å›æ ‡è®° â†’ å†™å…¥MySQL â†’ æ›´æ–°RedisçŠ¶æ€
```

---

### 2. æ¶ˆæ¯æŸ¥è¯¢æµç¨‹

```
ç”¨æˆ·AæŸ¥è¯¢ä¸ç”¨æˆ·Bçš„å†å²æ¶ˆæ¯
    â†“
Step 1: æŸ¥è¯¢Redisç¼“å­˜
Key: msg:conv:1_2
Result: æœ€è¿‘100æ¡æ¶ˆæ¯ (JSONæ•°ç»„)
    â†“
Step 2: è¿‡æ»¤å·²åˆ é™¤æ¶ˆæ¯
æ£€æŸ¥ msg:deleted:1 ä¸­æ˜¯å¦åŒ…å«messageId
    â†“
Step 3: Redisæ•°é‡ä¸è¶³ï¼ŒæŸ¥è¯¢MySQL
SELECT * FROM message 
WHERE (fromUserId=1 AND toId=2) OR (fromUserId=2 AND toId=1)
  AND chatType=1
  AND status=1
  AND id NOT IN (SELECT messageId FROM message_delete WHERE userId=1)
ORDER BY sendTime DESC
LIMIT 20 OFFSET 0
    â†“
Step 4: åˆå¹¶å»é‡
Redisæ¶ˆæ¯ + MySQLæ¶ˆæ¯ â†’ æŒ‰æ—¶é—´æ’åº â†’ è¿”å›
```

---

### 3. æ¶ˆæ¯æ’¤å›æµç¨‹

```
ç”¨æˆ·Aæ’¤å›5åˆ†é’Ÿå†…çš„æ¶ˆæ¯
    â†“
Step 1: éªŒè¯æƒé™å’Œæ—¶é—´
- åªèƒ½æ’¤å›è‡ªå·±çš„æ¶ˆæ¯
- å‘é€æ—¶é—´ < 5åˆ†é’Ÿ
    â†“
Step 2: æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€
ä» msg:detail:{messageId} è¯»å– persistStatus
    â†“
Case A: persistStatus = "PENDING" (æ¶ˆæ¯è¿˜åœ¨é˜Ÿåˆ—ä¸­)
â”œâ”€ è®¾ç½®æ’¤å›æ ‡è®°: msg:cancel:{messageId} = "1" (TTL: 10åˆ†é’Ÿ)
â”œâ”€ æ›´æ–°Redisæ¶ˆæ¯çŠ¶æ€: status=0, recallTime=now
â””â”€ Kafkaæ¶ˆè´¹è€…ä¼šæ£€æŸ¥æ ‡è®°ï¼Œè·³è¿‡æŒä¹…åŒ–
    â†“
Case B: persistStatus = "PERSISTED" (æ¶ˆæ¯å·²å…¥åº“)
â”œâ”€ å‘é€æ’¤å›äº‹ä»¶åˆ°Kafka: {"action":"RECALL", "messageId":xxx}
â”œâ”€ æ›´æ–°Redisæ¶ˆæ¯çŠ¶æ€: status=0
â””â”€ Kafkaæ¶ˆè´¹è€…æ›´æ–°MySQL: UPDATE message SET status=0
    â†“
Step 3: WebSocketé€šçŸ¥ç”¨æˆ·B
{"type":"MESSAGE_RECALLED", "messageId": xxx}
    â†“
ç”¨æˆ·Bç•Œé¢æ˜¾ç¤º "å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯"
```

---

### 4. Kafkaæ¶ˆè´¹è€…é€»è¾‘

```java
@KafkaListener(topics = "im-message-private", groupId = "im-consumer")
public void consumeMessage(String messageJson) {
    
    JSONObject json = JSON.parseObject(messageJson);
    String action = json.getString("action");
    
    if ("PERSIST".equals(action)) {
        // ========== æŒä¹…åŒ–æ¶ˆæ¯ ==========
        Message msg = json.getObject("data", Message.class);
        Long messageId = msg.getId();
        
        // 1. æ£€æŸ¥æ’¤å›æ ‡è®°ï¼ˆä¸‰æ¬¡æ£€æŸ¥æœºåˆ¶ï¼‰
        String cancelKey = "msg:cancel:" + messageId;
        if (redisTemplate.hasKey(cancelKey)) {
            log.info("æ¶ˆæ¯å·²æ’¤å›ï¼Œè·³è¿‡æŒä¹…åŒ–: {}", messageId);
            redisTemplate.delete("msg:detail:" + messageId);
            return;
        }
        
        // 2. å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤æ¶ˆè´¹ï¼‰
        String lockKey = "msg:lock:" + messageId;
        Boolean acquired = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, "1", 10, TimeUnit.SECONDS);
        
        if (Boolean.FALSE.equals(acquired)) {
            log.warn("æ¶ˆæ¯æ­£åœ¨å¤„ç†æˆ–å·²å¤„ç†ï¼Œè·³è¿‡: {}", messageId);
            return;
        }
        
        try {
            // 3. å†æ¬¡æ£€æŸ¥æ’¤å›æ ‡è®°ï¼ˆå†™åº“å‰ï¼‰
            if (redisTemplate.hasKey(cancelKey)) {
                return;
            }
            
            // 4. å†™å…¥MySQL
            messageMapper.insert(msg);
            log.info("æ¶ˆæ¯æŒä¹…åŒ–æˆåŠŸ: {}", messageId);
            
            // 5. æœ€åæ£€æŸ¥æ’¤å›æ ‡è®°ï¼ˆå†™åº“åï¼‰
            if (redisTemplate.hasKey(cancelKey)) {
                // åˆšå†™å…¥å°±è¢«æ’¤å›äº†ï¼Œç«‹å³åˆ é™¤
                messageMapper.deleteById(messageId);
                log.warn("æ¶ˆæ¯å†™åº“åè¢«æ’¤å›ï¼Œå·²åˆ é™¤: {}", messageId);
                return;
            }
            
            // 6. æ›´æ–°RedisçŠ¶æ€
            String detailKey = "msg:detail:" + messageId;
            String msgJson = redisTemplate.opsForValue().get(detailKey);
            if (msgJson != null) {
                Message cachedMsg = JSON.parseObject(msgJson, Message.class);
                cachedMsg.setPersistStatus("PERSISTED");
                redisTemplate.opsForValue()
                    .set(detailKey, JSON.toJSONString(cachedMsg), 30, TimeUnit.MINUTES);
            }
            
        } finally {
            redisTemplate.delete(lockKey);
        }
        
    } else if ("RECALL".equals(action)) {
        // ========== æ’¤å›æ¶ˆæ¯ ==========
        Long messageId = json.getLong("messageId");
        Long recallTime = json.getLong("recallTime");
        
        // æ›´æ–°MySQL
        messageMapper.updateRecallStatus(messageId, recallTime);
        log.info("æ¶ˆæ¯æ’¤å›æˆåŠŸï¼ˆæ•°æ®åº“ï¼‰: {}", messageId);
    }
}
```

---

### 5. è¡¥å¿æœºåˆ¶

```java
/**
 * å®šæ—¶ä»»åŠ¡ï¼šæ£€æŸ¥PENDINGè¶…æ—¶çš„æ¶ˆæ¯
 * æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
 */
@Scheduled(cron = "0 * * * * ?")
public void compensatePendingMessages() {
    
    // 1. æ‰«æRedisä¸­æ‰€æœ‰æ¶ˆæ¯è¯¦æƒ…
    Set<String> keys = redisTemplate.keys("msg:detail:*");
    if (keys == null || keys.isEmpty()) {
        return;
    }
    
    int compensateCount = 0;
    long now = System.currentTimeMillis();
    
    for (String key : keys) {
        String msgJson = redisTemplate.opsForValue().get(key);
        if (msgJson == null) continue;
        
        Message msg = JSON.parseObject(msgJson, Message.class);
        
        // 2. æ£€æŸ¥æ¡ä»¶ï¼šPENDINGçŠ¶æ€ + è¶…è¿‡5åˆ†é’Ÿ
        if (!"PENDING".equals(msg.getPersistStatus())) {
            continue;
        }
        
        if (now - msg.getSendTime().getTime() < 5 * 60 * 1000) {
            continue;
        }
        
        // 3. æ£€æŸ¥MySQLæ˜¯å¦å·²å­˜åœ¨
        Message dbMsg = messageMapper.selectById(msg.getId());
        if (dbMsg != null) {
            // æ•°æ®åº“å·²æœ‰ï¼Œæ›´æ–°RedisçŠ¶æ€
            msg.setPersistStatus("PERSISTED");
            redisTemplate.opsForValue()
                .set(key, JSON.toJSONString(msg), 30, TimeUnit.MINUTES);
            log.info("è¡¥å¿ä»»åŠ¡ï¼šæ¶ˆæ¯å·²åœ¨æ•°æ®åº“ï¼Œæ›´æ–°çŠ¶æ€: {}", msg.getId());
            continue;
        }
        
        // 4. æ£€æŸ¥æ˜¯å¦è¢«æ’¤å›
        if (redisTemplate.hasKey("msg:cancel:" + msg.getId())) {
            // å·²æ’¤å›ï¼Œåˆ é™¤Redis
            redisTemplate.delete(key);
            log.info("è¡¥å¿ä»»åŠ¡ï¼šæ¶ˆæ¯å·²æ’¤å›ï¼Œæ¸…ç†Redis: {}", msg.getId());
            continue;
        }
        
        // 5. æ•°æ®åº“æ²¡æœ‰ï¼Œé‡æ–°å‘é€åˆ°Kafka
        kafkaTemplate.send("im-message-private", JSON.toJSONString(Map.of(
            "action", "PERSIST",
            "data", msg
        )));
        
        log.warn("è¡¥å¿ä»»åŠ¡ï¼šå‘ç°æœªæŒä¹…åŒ–æ¶ˆæ¯ï¼Œé‡æ–°å‘é€: {}", msg.getId());
        compensateCount++;
    }
    
    if (compensateCount > 0) {
        log.warn("è¡¥å¿ä»»åŠ¡å®Œæˆï¼Œé‡æ–°å‘é€æ¶ˆæ¯æ•°: {}", compensateCount);
    }
}
```

---

## ğŸ”‘ Redis Keyè®¾è®¡

| Key | Type | è¯´æ˜ | TTL | ç¤ºä¾‹ |
|-----|------|------|-----|------|
| `msg:detail:{messageId}` | String | å•æ¡æ¶ˆæ¯è¯¦æƒ… | 30åˆ†é’Ÿ | `msg:detail:1234567890` |
| `msg:conv:{convId}` | List | ä¼šè¯æ¶ˆæ¯åˆ—è¡¨ | 30åˆ†é’Ÿ | `msg:conv:1_2` |
| `msg:unread:{userId}` | Set | ç”¨æˆ·æœªè¯»æ¶ˆæ¯ID | æ°¸ä¹… | `msg:unread:2` |
| `msg:deleted:{userId}` | Set | ç”¨æˆ·å·²åˆ é™¤æ¶ˆæ¯ID | 30åˆ†é’Ÿ | `msg:deleted:1` |
| `msg:cancel:{messageId}` | String | æ’¤å›æ ‡è®° | 10åˆ†é’Ÿ | `msg:cancel:1234567890` |
| `msg:lock:{messageId}` | String | æ¶ˆè´¹é” | 10ç§’ | `msg:lock:1234567890` |

### ConversationIdç”Ÿæˆè§„åˆ™

```java
// å•èŠï¼šuserId1 < userId2
public String generateConvId(Long userId1, Long userId2) {
    long min = Math.min(userId1, userId2);
    long max = Math.max(userId1, userId2);
    return min + "_" + max;
}

// ç¤ºä¾‹ï¼š
// ç”¨æˆ·1å’Œç”¨æˆ·2çš„ä¼šè¯: "1_2"
// ç”¨æˆ·5å’Œç”¨æˆ·3çš„ä¼šè¯: "3_5"
```

---

## ğŸ“¦ æ•°æ®åº“è®¾è®¡

### messageè¡¨æ–°å¢å­—æ®µ

```sql
ALTER TABLE message 
ADD COLUMN persist_status VARCHAR(20) DEFAULT 'PENDING' COMMENT 'æŒä¹…åŒ–çŠ¶æ€ï¼šPENDING-å¾…æŒä¹…åŒ–, PERSISTED-å·²æŒä¹…åŒ–';

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_persist_status ON message(persist_status, send_time);
```

---

## âš™ï¸ é…ç½®æ–‡ä»¶

### application.yml

```yaml
spring:
  # Kafkaé…ç½®
  kafka:
    bootstrap-servers: localhost:9092
    producer:
      # æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼šallè¡¨ç¤ºæ‰€æœ‰å‰¯æœ¬éƒ½ç¡®è®¤
      acks: all
      # é‡è¯•æ¬¡æ•°
      retries: 3
      # æ‰¹é‡å‘é€å¤§å°
      batch-size: 16384
      # å‘é€ç¼“å†²åŒº
      buffer-memory: 33554432
      # åºåˆ—åŒ–
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
      
    consumer:
      # æ¶ˆè´¹è€…ç»„
      group-id: im-message-consumer
      # æ‰‹åŠ¨æäº¤offset
      enable-auto-commit: false
      # æ¯æ¬¡æ‹‰å–çš„æœ€å¤§æ¶ˆæ¯æ•°
      max-poll-records: 100
      # ååºåˆ—åŒ–
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      # ä»æœ€æ—©çš„æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹
      auto-offset-reset: earliest
      
    listener:
      # æ‰‹åŠ¨ç¡®è®¤æ¨¡å¼
      ack-mode: manual

  # Redisé…ç½®
  redis:
    host: localhost
    port: 6379
    password: 123456
    database: 1
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 100
        max-idle: 50
        min-idle: 10
        max-wait: 3000ms

# è‡ªå®šä¹‰é…ç½®
im:
  message:
    # ä¼šè¯ç¼“å­˜æ¶ˆæ¯æ•°é‡
    conv-cache-size: 1000
    # Redisç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    cache-expire-minutes: 30
    # æ¶ˆæ¯æ’¤å›æ—¶é—´é™åˆ¶ï¼ˆåˆ†é’Ÿï¼‰
    recall-time-limit: 5
    # Kafka Topic
    kafka-topic: im-message-private
    # Kafkaåˆ†åŒºæ•°
    kafka-partitions: 10
```

### pom.xmlä¾èµ–

```xml
<!-- Kafka -->
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>

<!-- Redis -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>io.lettuce</groupId>
    <artifactId>lettuce-core</artifactId>
</dependency>
```

---

## ğŸ”’ æ•°æ®ä¸€è‡´æ€§ä¿è¯

### 1. æ¶ˆæ¯ä¸ä¸¢å¤±

```
å±‚æ¬¡           ç­–ç•¥                         æ¢å¤æœºåˆ¶
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Rediså®•æœº   â†’ AOFæŒä¹…åŒ– + RDBå¿«ç…§       â†’ ä»MySQLæ¢å¤æœ€è¿‘æ¶ˆæ¯
Kafkaä¸¢å¤±   â†’ 3å‰¯æœ¬ + acks=all          â†’ è¡¥å¿ä»»åŠ¡é‡æ–°å‘é€
æ¶ˆè´¹å¤±è´¥    â†’ æ­»ä¿¡é˜Ÿåˆ— + é‡è¯•           â†’ äººå·¥ä»‹å…¥å¤„ç†
MySQLå¤±è´¥   â†’ äº‹åŠ¡å›æ»š + Kafkaé‡è¯•      â†’ è‡ªåŠ¨é‡è¯•3æ¬¡
```

### 2. æ¶ˆæ¯ä¸é‡å¤

```java
// æ–¹æ¡ˆ1: MySQLå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX uk_message_id ON message(id);

// æ–¹æ¡ˆ2: Redisåˆ†å¸ƒå¼é”
String lockKey = "msg:lock:" + messageId;
Boolean acquired = redisTemplate.opsForValue()
    .setIfAbsent(lockKey, "1", 10, TimeUnit.SECONDS);

if (acquired) {
    // æ‰§è¡Œæ’å…¥
    messageMapper.insert(msg);
} else {
    // å·²è¢«å¤„ç†ï¼Œè·³è¿‡
    log.warn("é‡å¤æ¶ˆè´¹ï¼Œè·³è¿‡: {}", messageId);
}
```

### 3. æ¶ˆæ¯é¡ºåºæ€§

```java
// KafkaæŒ‰ä¼šè¯IDåˆ†åŒºï¼Œä¿è¯åŒä¸€ä¼šè¯æ¶ˆæ¯æœ‰åº
String conversationId = generateConvId(fromUserId, toId);
int partition = Math.abs(conversationId.hashCode()) % kafkaPartitions;

kafkaTemplate.send("im-message-private", partition, conversationId, messageJson);
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å†™å…¥æ€§èƒ½

| æ“ä½œ | è€—æ—¶ | QPS |
|------|------|-----|
| Rediså†™å…¥ | 1ms | 100,000+ |
| Kafkaå‘é€ | 5ms | 50,000+ |
| æ€»å“åº”æ—¶é—´ | <10ms | **10,000+** |

### å¼‚æ­¥æŒä¹…åŒ–

| é˜¶æ®µ | è€—æ—¶ | ååé‡ |
|------|------|--------|
| Kafkaæ¶ˆè´¹å»¶è¿Ÿ | 100ms-1s | - |
| MySQLæ‰¹é‡å†™å…¥ | 10ms/æ¡ | 5,000-10,000æ¡/ç§’ |

### æŸ¥è¯¢æ€§èƒ½

| åœºæ™¯ | è€—æ—¶ |
|------|------|
| Redisç¼“å­˜å‘½ä¸­ | <5ms |
| Redisæœªå‘½ä¸­æŸ¥MySQL | 50ms-200ms |

---

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

### 1. æ’¤å›ç«æ€æ¡ä»¶

**é—®é¢˜**ï¼šç”¨æˆ·æ’¤å›æ—¶ï¼Œæ¶ˆæ¯å¯èƒ½æ­£åœ¨å†™åº“

**è§£å†³**ï¼šä¸‰æ¬¡æ£€æŸ¥æœºåˆ¶
```
æ¶ˆè´¹å¼€å§‹ â†’ æ£€æŸ¥æ’¤å›æ ‡è®° â‘ 
å†™åº“ä¹‹å‰ â†’ æ£€æŸ¥æ’¤å›æ ‡è®° â‘¡
å†™åº“å®Œæˆ â†’ æ£€æŸ¥æ’¤å›æ ‡è®° â‘¢ï¼ˆå¦‚æœè¢«æ’¤å›ï¼Œç«‹å³åˆ é™¤ï¼‰
```

### 2. Rediså†…å­˜ç®¡ç†

**ç­–ç•¥**ï¼š
- å•æ¡æ¶ˆæ¯ï¼š30åˆ†é’Ÿè¿‡æœŸ
- ä¼šè¯åˆ—è¡¨ï¼šåªä¿ç•™æœ€è¿‘1000æ¡
- å®šæœŸæ¸…ç†ï¼šä½¿ç”¨Redisçš„LRUæ·˜æ±°ç­–ç•¥

```yaml
redis.conf:
  maxmemory 2gb
  maxmemory-policy allkeys-lru
```

### 3. Kafkaæ¶ˆè´¹å¤±è´¥

**ç­–ç•¥**ï¼š
```java
@KafkaListener(topics = "im-message-private")
public void consume(ConsumerRecord<String, String> record, Acknowledgment ack) {
    try {
        processMessage(record.value());
        // æ‰‹åŠ¨æäº¤
        ack.acknowledge();
    } catch (Exception e) {
        log.error("æ¶ˆè´¹å¤±è´¥: {}", record.value(), e);
        // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
        kafkaTemplate.send("im-message-dead-letter", record.value());
        // ä»ç„¶ç¡®è®¤æ¶ˆè´¹ï¼Œé¿å…é˜»å¡
        ack.acknowledge();
    }
}
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1: æ­£å¸¸å‘é€

```
ç”¨æˆ·Aå‘é€æ¶ˆæ¯ â†’ Rediså†™å…¥æˆåŠŸ â†’ Kafkaå‘é€æˆåŠŸ â†’ è¿”å›<10ms
â†’ 3ç§’åæ¶ˆè´¹è€…å†™å…¥MySQL â†’ RedisçŠ¶æ€æ›´æ–°ä¸ºPERSISTED
```

### åœºæ™¯2: å¿«é€Ÿæ’¤å›

```
ç”¨æˆ·Aå‘é€æ¶ˆæ¯ â†’ Redis(PENDING) â†’ Kafkaé˜Ÿåˆ—
â†’ 2ç§’åç”¨æˆ·Aæ’¤å› â†’ è®¾ç½®cancelæ ‡è®°
â†’ æ¶ˆè´¹è€…æ£€æŸ¥åˆ°cancel â†’ è·³è¿‡æŒä¹…åŒ– â†’ åˆ é™¤Redis
```

### åœºæ™¯3: å»¶è¿Ÿæ’¤å›

```
ç”¨æˆ·Aå‘é€æ¶ˆæ¯ â†’ Redis â†’ Kafka â†’ 1ç§’åå†™å…¥MySQL(PERSISTED)
â†’ 3åˆ†é’Ÿåç”¨æˆ·Aæ’¤å› â†’ å‘é€RECALLäº‹ä»¶åˆ°Kafka
â†’ æ¶ˆè´¹è€…æ›´æ–°MySQL.status=0 â†’ æ›´æ–°Redis
```

### åœºæ™¯4: æ’¤å›ç«æ€

```
T0: æ¶ˆæ¯å‘é€ï¼Œè¿›å…¥Kafka
T1: æ¶ˆè´¹è€…å–å‡ºæ¶ˆæ¯ï¼Œæ£€æŸ¥cancel(âœ“æ— ) â†’ å‡†å¤‡å†™åº“
T2: ç”¨æˆ·ç‚¹æ’¤å›ï¼Œè®¾ç½®cancelæ ‡è®°
T3: æ¶ˆè´¹è€…å†™åº“å‰å†æ¬¡æ£€æŸ¥cancel(âœ—æœ‰) â†’ è·³è¿‡å†™åº“
```

### åœºæ™¯5: è¡¥å¿æ¢å¤

```
æ¶ˆæ¯å‘é€ â†’ Redis(PENDING) â†’ Kafkaå‘é€å¤±è´¥ï¼ˆç½‘ç»œæ•…éšœï¼‰
â†’ 5åˆ†é’Ÿåè¡¥å¿ä»»åŠ¡æ£€æµ‹åˆ° â†’ é‡æ–°å‘é€Kafka â†’ æˆåŠŸæŒä¹…åŒ–
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤

### é˜¶æ®µ1: åŸºç¡€è®¾æ–½æ­å»º
1. âœ… å®‰è£…Kafkaï¼ˆå•æœºæˆ–é›†ç¾¤ï¼‰
2. âœ… é…ç½®RedisæŒä¹…åŒ–ï¼ˆAOF+RDBï¼‰
3. âœ… åˆ›å»ºKafka Topicï¼ˆ10åˆ†åŒºï¼‰

### é˜¶æ®µ2: ä»£ç å®ç°
1. âœ… æ·»åŠ ä¾èµ–å’Œé…ç½®
2. âœ… ä¿®æ”¹Messageå®ä½“ï¼ˆå¢åŠ persistStatuså­—æ®µï¼‰
3. âœ… å®ç°æ¶ˆæ¯å‘é€é€»è¾‘ï¼ˆRedis+Kafkaï¼‰
4. âœ… å®ç°Kafkaæ¶ˆè´¹è€…
5. âœ… å®ç°è¡¥å¿ä»»åŠ¡
6. âœ… ä¿®æ”¹æ¶ˆæ¯æŸ¥è¯¢é€»è¾‘

### é˜¶æ®µ3: æµ‹è¯•éªŒè¯
1. âœ… å•å…ƒæµ‹è¯•
2. âœ… é›†æˆæµ‹è¯•
3. âœ… å‹åŠ›æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿ10,000 QPSï¼‰
4. âœ… æ•…éšœæ¼”ç»ƒï¼ˆRediså®•æœºã€Kafkaæ•…éšœï¼‰

### é˜¶æ®µ4: ä¸Šçº¿å‘å¸ƒ
1. âœ… ç°åº¦å‘å¸ƒï¼ˆ10%æµé‡ï¼‰
2. âœ… ç›‘æ§å‘Šè­¦
3. âœ… å…¨é‡å‘å¸ƒ

---

## ğŸ”§ è¿ç»´ç›‘æ§

### å…³é”®æŒ‡æ ‡

```yaml
ç›‘æ§æŒ‡æ ‡:
  - Rediså‘½ä¸­ç‡: >95%
  - Kafkaæ¶ˆè´¹å»¶è¿Ÿ: <1s
  - MySQLå†™å…¥æˆåŠŸç‡: >99.9%
  - æ¶ˆæ¯å‘é€è€—æ—¶: P99 <10ms
  - PENDINGæ¶ˆæ¯æ•°é‡: <1000
  - è¡¥å¿ä»»åŠ¡æ‰§è¡Œæ¬¡æ•°: æ¯å°æ—¶<10æ¬¡
```

### å‘Šè­¦è§„åˆ™

```yaml
å‘Šè­¦:
  - Rediså‘½ä¸­ç‡ < 90% â†’ è­¦å‘Š
  - Kafkaæ¶ˆè´¹å»¶è¿Ÿ > 3s â†’ è­¦å‘Š
  - PENDINGæ¶ˆæ¯æ•°é‡ > 5000 â†’ ä¸¥é‡
  - è¡¥å¿ä»»åŠ¡æ‰§è¡Œæ¬¡æ•° > 50/å°æ—¶ â†’ ä¸¥é‡
  - æ¶ˆæ¯å‘é€å¤±è´¥ç‡ > 0.1% â†’ ä¸¥é‡
```

---

## ğŸ¯ åç»­ä¼˜åŒ–æ–¹å‘

1. **åˆ†åº“åˆ†è¡¨**ï¼šæŒ‰ç”¨æˆ·IDæˆ–æ—¶é—´ç»´åº¦åˆ†è¡¨
2. **æ¶ˆæ¯å‹ç¼©**ï¼šKafkaæ¶ˆæ¯ä½¿ç”¨GZIPå‹ç¼©
3. **è¯»å†™åˆ†ç¦»**ï¼šMySQLä¸»ä»å¤åˆ¶ï¼Œè¯»æ“ä½œèµ°ä»åº“
4. **å†·çƒ­åˆ†ç¦»**ï¼š7å¤©å‰çš„æ¶ˆæ¯å½’æ¡£åˆ°HBase
5. **æ™ºèƒ½ç¼“å­˜**ï¼šæ ¹æ®ç”¨æˆ·æ´»è·ƒåº¦åŠ¨æ€è°ƒæ•´ç¼“å­˜ç­–ç•¥

---

## ğŸ“š å‚è€ƒèµ„æ–™

- Spring Kafkaå®˜æ–¹æ–‡æ¡£
- RedisæŒä¹…åŒ–æœ€ä½³å®è·µ
- å¾®ä¿¡æŠ€æœ¯æ¶æ„åˆ†äº«
- é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡æ¨¡å¼
