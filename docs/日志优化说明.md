# æ—¥å¿—ä¼˜åŒ–è¯´æ˜

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

å·²å¯¹åç«¯æ—¥å¿—è¿›è¡Œå…¨é¢ä¼˜åŒ–ï¼Œå¤§å¹…å‡å°‘å†—ä½™æ—¥å¿—è¾“å‡ºï¼Œåªä¿ç•™å…³é”®ä¸šåŠ¡æ—¥å¿—ã€‚

---

## ğŸ¯ ä¼˜åŒ–å†…å®¹

### 1. é…ç½®æ–‡ä»¶è°ƒæ•´

#### ç”¨æˆ·æœåŠ¡ (`im-user-service`)

**`application.yml`**:
```yaml
logging:
  level:
    root: WARN                    # æ ¹æ—¥å¿—çº§åˆ«ï¼šè­¦å‘Š
    com.im.user: INFO             # ä¸šåŠ¡æ—¥å¿—ï¼šä¿¡æ¯
    org.springframework.web: WARN # Spring Webï¼šè­¦å‘Š
    org.mybatis: WARN             # MyBatisï¼šè­¦å‘Š
    com.alibaba.druid: WARN       # Druidè¿æ¥æ± ï¼šè­¦å‘Š
```

**`logback-spring.xml`**:
- ä¸šåŠ¡æ—¥å¿—ï¼š`INFO`
- æ¡†æ¶æ—¥å¿—ï¼š`WARN`
- MyBatisæ—¥å¿—ï¼š`WARN`ï¼ˆå…³é—­SQLè¯¦ç»†è¾“å‡ºï¼‰
- æ•°æ®åº“è¿æ¥æ± ï¼š`WARN`

#### æ¶ˆæ¯æœåŠ¡ (`im-message-service`)

**`application.yml`**:
```yaml
logging:
  level:
    root: WARN                        # æ ¹æ—¥å¿—çº§åˆ«ï¼šè­¦å‘Š
    com.im.message: INFO              # ä¸šåŠ¡æ—¥å¿—ï¼šä¿¡æ¯
    org.springframework.web: WARN     # Spring Webï¼šè­¦å‘Š
    org.springframework.messaging: WARN   # WebSocketæ¶ˆæ¯ï¼šè­¦å‘Š
    org.springframework.websocket: WARN   # WebSocketï¼šè­¦å‘Š
    org.mybatis: WARN                 # MyBatisï¼šè­¦å‘Š
    com.alibaba.druid: WARN           # Druidè¿æ¥æ± ï¼šè­¦å‘Š
```

**MyBatisé…ç½®**:
```yaml
mybatis:
  configuration:
    # log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl  # å·²æ³¨é‡Šï¼Œå…³é—­SQLè¯¦ç»†æ—¥å¿—
```

---

### 2. ä»£ç è°ƒæ•´

#### å·²å…³é—­çš„é¢‘ç¹æ—¥å¿—

**JWTæ‹¦æˆªå™¨** (`JwtInterceptor.java`):
```java
// âœ… å·²æ³¨é‡Šï¼šTokenéªŒè¯é€šè¿‡æ—¥å¿—ï¼ˆæ¯æ¬¡è¯·æ±‚éƒ½ä¼šè§¦å‘ï¼‰
// log.debug("TokenéªŒè¯é€šè¿‡ï¼ŒuserId: {}", userId);
// log.debug("TokenéªŒè¯é€šè¿‡å¹¶ç»­æœŸï¼ŒuserId: {}", userId);

// âœ… å·²æ³¨é‡Šï¼šæ¸…é™¤ç”¨æˆ·ä¿¡æ¯æ—¥å¿—ï¼ˆæ¯æ¬¡è¯·æ±‚éƒ½ä¼šè§¦å‘ï¼‰
// log.debug("JWTæ‹¦æˆªå™¨ï¼šæ¸…é™¤å½“å‰ç”¨æˆ·ä¿¡æ¯");
```

**WebSocketå¿ƒè·³** (`WebSocketController.java`):
```java
// âœ… å·²æ³¨é‡Šï¼šå¿ƒè·³æ—¥å¿—ï¼ˆæ¯30ç§’è§¦å‘ä¸€æ¬¡ï¼‰
// log.debug("æ”¶åˆ°å¿ƒè·³: {}", heartbeat);
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### ä¼˜åŒ–å‰çš„æ—¥å¿—è¾“å‡º

```log
2025-11-27 20:43:01 - TokenéªŒè¯é€šè¿‡ï¼ŒuserId: 5
2025-11-27 20:43:01 - è·å–å†å²æ¶ˆæ¯: userId=5, targetId=7
2025-11-27 20:43:01 - ==>  Preparing: SELECT m.* FROM message...
2025-11-27 20:43:01 - ==> Parameters: 5(Long), 5(Long), 7(Long)...
2025-11-27 20:43:01 - <==      Total: 7
2025-11-27 20:43:01 - JWTæ‹¦æˆªå™¨ï¼šæ¸…é™¤å½“å‰ç”¨æˆ·ä¿¡æ¯
2025-11-27 20:43:02 - æ”¶åˆ°å¿ƒè·³: {type=HEARTBEAT}
2025-11-27 20:43:02 - TokenéªŒè¯é€šè¿‡ï¼ŒuserId: 7
2025-11-27 20:43:02 - æ ‡è®°æ¶ˆæ¯å·²è¯»: userId=7, messageIds=[18]
2025-11-27 20:43:02 - ==>  Preparing: INSERT INTO message_read...
2025-11-27 20:43:02 - JWTæ‹¦æˆªå™¨ï¼šæ¸…é™¤å½“å‰ç”¨æˆ·ä¿¡æ¯
... (å¤§é‡é‡å¤æ—¥å¿—)
```

### ä¼˜åŒ–åçš„æ—¥å¿—è¾“å‡º

```log
2025-11-27 20:43:01 - è·å–å†å²æ¶ˆæ¯: userId=5, targetId=7
2025-11-27 20:43:02 - æ ‡è®°æ¶ˆæ¯å·²è¯»: userId=7, messageIds=[18]
2025-11-27 20:43:05 - å‘é€æ¶ˆæ¯: from=5, to=7, type=TEXT
```

**å‡å°‘çº¦ 80% çš„æ—¥å¿—è¾“å‡º** âœ…

---

## ğŸ” ä¿ç•™çš„å…³é”®æ—¥å¿—

### 1. ä¸šåŠ¡æ“ä½œæ—¥å¿— (INFO)

- âœ… ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ç™»å‡º
- âœ… å‘é€éªŒè¯ç 
- âœ… å‘é€æ¶ˆæ¯
- âœ… å¥½å‹ç”³è¯·/åŒæ„/æ‹’ç»
- âœ… ç¾¤ç»„åˆ›å»º/è§£æ•£
- âœ… ç¾¤ç»„é‚€è¯·/åŠ å…¥/é€€å‡º

### 2. è­¦å‘Šæ—¥å¿— (WARN)

- âš ï¸ Tokenè§£æå¤±è´¥
- âš ï¸ Tokenæœªæ‰¾åˆ°æˆ–å·²è¿‡æœŸ
- âš ï¸ Tokenä¸åŒ¹é…ï¼ˆé‡å¤ç™»å½•ï¼‰
- âš ï¸ ä¸šåŠ¡å¼‚å¸¸æç¤º

### 3. é”™è¯¯æ—¥å¿— (ERROR)

- âŒ ç³»ç»Ÿå¼‚å¸¸
- âŒ æ•°æ®åº“å¼‚å¸¸
- âŒ Redisè¿æ¥å¼‚å¸¸
- âŒ å…¶ä»–è¿è¡Œæ—¶é”™è¯¯

---

## ğŸ“ æ—¥å¿—çº§åˆ«è¯´æ˜

| çº§åˆ« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ERROR** | ç³»ç»Ÿé”™è¯¯ï¼Œéœ€è¦ç«‹å³å¤„ç† | æ•°æ®åº“è¿æ¥å¤±è´¥ã€ç©ºæŒ‡é’ˆå¼‚å¸¸ |
| **WARN** | è­¦å‘Šä¿¡æ¯ï¼Œéœ€è¦å…³æ³¨ | Tokenå¤±æ•ˆã€å‚æ•°æ ¡éªŒå¤±è´¥ |
| **INFO** | å…³é”®ä¸šåŠ¡æ“ä½œ | ç”¨æˆ·ç™»å½•ã€å‘é€æ¶ˆæ¯ã€å¥½å‹ç”³è¯· |
| **DEBUG** | è°ƒè¯•ä¿¡æ¯ï¼ˆå·²å…³é—­ï¼‰ | TokenéªŒè¯ã€SQLè¯­å¥ã€å¿ƒè·³ |
| **TRACE** | è¯¦ç»†è¿½è¸ªï¼ˆå·²å…³é—­ï¼‰ | æ–¹æ³•è°ƒç”¨æ ˆã€å˜é‡å€¼ |

---

## ğŸ› ï¸ å¦‚ä½•ä¸´æ—¶å¼€å¯è¯¦ç»†æ—¥å¿—

### æ–¹å¼1ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆéœ€é‡å¯ï¼‰

**ä¸´æ—¶å¼€å¯SQLæ—¥å¿—**:
```yaml
# application.yml
logging:
  level:
    com.im.message.mapper: DEBUG  # å¼€å¯Mapper SQLæ—¥å¿—
    org.mybatis: DEBUG            # å¼€å¯MyBatisæ—¥å¿—

mybatis:
  configuration:
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl  # å–æ¶ˆæ³¨é‡Š
```

**ä¸´æ—¶å¼€å¯JWTæ—¥å¿—**:
```yaml
# application.yml
logging:
  level:
    com.im.message.interceptor: DEBUG
    com.im.user.interceptor: DEBUG
```

ç„¶ååœ¨ä»£ç ä¸­å–æ¶ˆæ³¨é‡Šç›¸åº”çš„ `log.debug()` è¯­å¥ã€‚

### æ–¹å¼2ï¼šä½¿ç”¨LogbackåŠ¨æ€è°ƒæ•´ï¼ˆæ— éœ€é‡å¯ï¼‰

é€šè¿‡JMXæˆ–ActuatoråŠ¨æ€è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼š

```bash
# å¦‚æœå¯ç”¨äº†Spring Boot Actuator
curl -X POST http://localhost:8082/actuator/loggers/com.im.message \
  -H "Content-Type: application/json" \
  -d '{"configuredLevel": "DEBUG"}'
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### é…ç½®æ–‡ä»¶
1. âœ… `im-user-service/src/main/resources/application.yml`
2. âœ… `im-user-service/src/main/resources/logback-spring.xml`
3. âœ… `im-message-service/src/main/resources/application.yml`
4. âœ… `im-message-service/src/main/resources/logback-spring.xml`

### ä»£ç æ–‡ä»¶
1. âœ… `im-user-service/src/main/java/com/im/user/interceptor/JwtInterceptor.java`
2. âœ… `im-message-service/src/main/java/com/im/message/interceptor/JwtInterceptor.java`
3. âœ… `im-message-service/src/main/java/com/im/message/controller/WebSocketController.java`

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### å¼€å‘ç¯å¢ƒ
```yaml
# å¯ä»¥ä¿æŒè¯¦ç»†æ—¥å¿—
logging:
  level:
    root: INFO
    com.im: DEBUG
```

### æµ‹è¯•ç¯å¢ƒ
```yaml
# é€‚åº¦æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•
logging:
  level:
    root: WARN
    com.im: INFO
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆå½“å‰é…ç½®ï¼‰
```yaml
# æœ€å°åŒ–æ—¥å¿—ï¼Œåªè®°å½•å…³é”®ä¿¡æ¯
logging:
  level:
    root: WARN
    com.im: INFO
```

---

## ğŸ¯ æ—¥å¿—è¾“å‡ºç¤ºä¾‹

### æ­£å¸¸ä¸šåŠ¡æµç¨‹

```log
2025-11-27 20:50:00 [http-nio-8081-exec-1] INFO  UserController - ç”¨æˆ·ç™»å½•: username=testuser
2025-11-27 20:50:01 [http-nio-8082-exec-2] INFO  MessageController - å‘é€æ¶ˆæ¯: from=5, to=7
2025-11-27 20:50:02 [http-nio-8081-exec-3] INFO  FriendController - å‘é€å¥½å‹ç”³è¯·: from=5, to=8
```

### å¼‚å¸¸æƒ…å†µ

```log
2025-11-27 20:51:00 [http-nio-8081-exec-4] WARN  JwtInterceptor - JWTè§£æå¤±è´¥: Tokenå·²è¿‡æœŸ
2025-11-27 20:51:01 [http-nio-8082-exec-5] ERROR MessageServiceImpl - å‘é€æ¶ˆæ¯å¤±è´¥
java.lang.NullPointerException: ...
    at com.im.message.service.impl.MessageServiceImpl.sendMessage(...)
```

---

## âœ… éªŒè¯ä¼˜åŒ–æ•ˆæœ

å¯åŠ¨æœåŠ¡åï¼Œè§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼š

**ä¼˜åŒ–å‰**ï¼š
- æ¯æ¬¡è¯·æ±‚ï¼š5-10è¡Œæ—¥å¿—
- å¿ƒè·³ï¼šæ¯30ç§’ä¸€æ¬¡æ—¥å¿—
- SQLï¼šæ¯æ¬¡æŸ¥è¯¢3-5è¡Œæ—¥å¿—

**ä¼˜åŒ–å**ï¼š
- æ¯æ¬¡è¯·æ±‚ï¼š0-1è¡Œæ—¥å¿—ï¼ˆä»…å…³é”®ä¸šåŠ¡ï¼‰
- å¿ƒè·³ï¼šæ— æ—¥å¿—
- SQLï¼šæ— æ—¥å¿—

**æ—¥å¿—å‡å°‘çº¦ 80-90%** ğŸ‰

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- Spring Bootæ—¥å¿—æ–‡æ¡£: https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.logging
- Logbacké…ç½®æ–‡æ¡£: https://logback.qos.ch/manual/configuration.html
- MyBatisæ—¥å¿—æ–‡æ¡£: https://mybatis.org/mybatis-3/logging.html
