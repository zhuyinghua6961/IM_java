<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.im.user.mapper.GroupMemberMapper">

    <resultMap id="BaseResultMap" type="com.im.user.entity.GroupMember">
        <id column="id" property="id"/>
        <result column="group_id" property="groupId"/>
        <result column="user_id" property="userId"/>
        <result column="role" property="role"/>
        <result column="nickname" property="nickname"/>
        <result column="join_time" property="joinTime"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 插入群成员 -->
    <insert id="insert" parameterType="com.im.user.entity.GroupMember" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO group_member (
            group_id,
            user_id,
            role,
            nickname,
            join_time,
            status
        ) VALUES (
            #{groupId},
            #{userId},
            #{role},
            #{nickname},
            #{joinTime},
            #{status}
        )
    </insert>

    <!-- 批量插入群成员 -->
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO group_member (
            group_id,
            user_id,
            role,
            nickname,
            join_time,
            status
        ) VALUES
        <foreach collection="members" item="member" separator=",">
            (
                #{member.groupId},
                #{member.userId},
                #{member.role},
                #{member.nickname},
                #{member.joinTime},
                #{member.status}
            )
        </foreach>
    </insert>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT *
        FROM group_member
        WHERE id = #{id}
    </select>

    <!-- 查询群成员列表 -->
    <select id="selectByGroupId" resultMap="BaseResultMap">
        SELECT *
        FROM group_member
        WHERE group_id = #{groupId}
          AND status = 1
        ORDER BY role DESC, join_time ASC
    </select>

    <!-- 查询用户在某个群的成员信息 -->
    <select id="selectByGroupIdAndUserId" resultMap="BaseResultMap">
        SELECT *
        FROM group_member
        WHERE group_id = #{groupId}
          AND user_id = #{userId}
          AND status = 1
    </select>

    <!-- 统计群成员数量 -->
    <select id="countByGroupId" resultType="int">
        SELECT COUNT(*)
        FROM group_member
        WHERE group_id = #{groupId}
          AND status = 1
    </select>

    <!-- 删除群成员（软删除） -->
    <update id="deleteById">
        UPDATE group_member
        SET status = 0
        WHERE id = #{id}
    </update>

    <!-- 更新成员角色 -->
    <update id="updateRole">
        UPDATE group_member
        SET role = #{role}
        WHERE id = #{id}
    </update>

    <!-- 更新群成员信息 -->
    <update id="updateById" parameterType="com.im.user.entity.GroupMember">
        UPDATE group_member
        SET status = #{status},
            role = #{role},
            nickname = #{nickname},
            update_time = #{updateTime}
        WHERE id = #{id}
    </update>

    <!-- 查询群组的管理员和群主 -->
    <select id="selectAdminsByGroupId" resultMap="BaseResultMap">
        SELECT *
        FROM group_member
        WHERE group_id = #{groupId}
          AND status = 1
          AND role IN (1, 2)  -- 1=管理员, 2=群主
        ORDER BY role DESC
    </select>

</mapper>
